version: v1.0
name: Fast tests pipeline (not building GDevelop.js)
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Install
    task:
      jobs:
        - name: Checkout and install dependencies
          commands:
            - checkout
            - node -v
            - cd newIDE/app
            - npm i
            - cd ../..
            - cd GDJS/tests
            - npm i
            - cd ../..
            - cd GDJS
            - npm i
            - cd ..
            - cache store newIDE-app-node_modules-$SEMAPHORE_GIT_BRANCH-revision-$(checksum newIDE/app/package-lock.json) newIDE/app/node_modules
            - cache store GDJS-node_modules-$SEMAPHORE_GIT_BRANCH-revision-$(checksum GDJS/package-lock.json) GDJS/node_modules
            - cache store GDJS-tests-node_modules-$SEMAPHORE_GIT_BRANCH-revision-$(checksum GDJS/tests/package-lock.json) GDJS/tests/node_modules
    dependencies: []
  - name: Type checks
    dependencies:
      - Install
    task:
      jobs:
        - name: newIDE typing
          commands:
            - checkout
            - cache restore newIDE-app-node_modules-$SEMAPHORE_GIT_BRANCH-revision-$(checksum newIDE/app/package-lock.json)
            - cache restore GDJS-node_modules-$SEMAPHORE_GIT_BRANCH-revision-$(checksum GDJS/package-lock.json)
            - cd newIDE/app
            - npm run postinstall
            - npm run flow
            - cd ../..
        - name: GDJS typing and documentation generation
          commands:
            - checkout
            - cache restore GDJS-node_modules-$SEMAPHORE_GIT_BRANCH-revision-$(checksum GDJS/package-lock.json)
            - cache restore GDJS-tests-node_modules-$SEMAPHORE_GIT_BRANCH-revision-$(checksum GDJS/tests/package-lock.json)
            - cd GDJS
            - npm run check-types
            - npm run generate-doc
  - name: Auto formatting
    dependencies:
      - Install
    task:
      jobs:
        - name: newIDE auto-formatting
          commands:
            - checkout
            - cache restore newIDE-app-node_modules-$SEMAPHORE_GIT_BRANCH-revision-$(checksum newIDE/app/package-lock.json)
            - cache restore GDJS-node_modules-$SEMAPHORE_GIT_BRANCH-revision-$(checksum GDJS/package-lock.json)
            - cd newIDE/app
            - npm run postinstall
            - npm run check-format
            - cd ../..
        - name: GDJS auto-formatting
          commands:
            - checkout
            - cache restore GDJS-node_modules-$SEMAPHORE_GIT_BRANCH-revision-$(checksum GDJS/package-lock.json)
            - cd GDJS
            - npm run check-format
            - cd ..
  - name: Tests
    dependencies:
      - Install
    task:
      jobs:
        - name: newIDE tests
          commands:
            - checkout
            - cache restore newIDE-app-node_modules-$SEMAPHORE_GIT_BRANCH-revision-$(checksum newIDE/app/package-lock.json)
            - cache restore GDJS-node_modules-$SEMAPHORE_GIT_BRANCH-revision-$(checksum GDJS/package-lock.json)
            - cd newIDE/app
            - npm run postinstall
            - npm run analyze-test-coverage
            - cd ../..
        - name: GDJS tests
          commands:
            - checkout
            - cache restore GDJS-node_modules-$SEMAPHORE_GIT_BRANCH-revision-$(checksum GDJS/package-lock.json)
            - cache restore GDJS-tests-node_modules-$SEMAPHORE_GIT_BRANCH-revision-$(checksum GDJS/tests/package-lock.json)
            - cd GDJS
            - npm run test
            - cd ../..
