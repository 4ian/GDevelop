{"version":3,"file":"BackgroundSerializer.worker.f8c037d0aa64c085d630.worker.js","mappings":"YAGA,IAAIA,EAA4C,KAEhD,MAAMC,EAAOC,IACXC,QAAQF,IAAI,gCAAgCC,IAAU,EA4ExDE,KAAKC,UAAYC,MAAOC,IAEtB,MAAM,KAAEC,EAAI,OAAEC,EAAM,UAAEC,EAAS,gBAAEC,GAAoBJ,EAAMK,MAAQ,CAAC,EAE9DC,EAAYC,KAAKC,MAGvB,GADAd,EAAI,YAAYS,eAAuBF,OAC1B,sBAATA,GAAyC,2BAATA,EAEpC,IACE,MAAMQ,OAnFa,CAACL,GAClBX,IAEJA,EAAgB,IAAIiB,SAAQ,CAACC,EAASC,KACpC,IACE,MAAMC,EAAM,0BAA0BT,IAOtC,GAJAU,cAAcD,GAIsB,oBAAzBE,qBAET,YADAH,EAAO,IAAII,MAAM,2CAKnBD,qBAAqB,CAGnBE,WAAY,CAACC,EAAoBC,IAMxBD,EAAO,iBAAiBd,MAGhCgB,MAAKC,IACJV,EAAQU,EAAO,IAEhBC,MAAMV,EACX,CAAE,MAAOW,GAEP,YADAX,EAAOW,EAET,KAGK9B,GA2CY+B,CAAepB,GAE1BqB,EA1C8B,EACtChB,EACAP,KAEA,MAAMwB,EACJxB,aAAkByB,WAAazB,EAAS,IAAIyB,WAAWzB,GACnD0B,EAAaF,EAAYG,YAAcH,EAAYI,OAGnDC,EAAYtB,EAAGuB,QAAQJ,GAC7BnB,EAAGwB,OAAOC,IAAIR,EAAaK,GAE3B,MAAMI,EAAU1B,EAAG2B,iBAAiBC,0BAClCN,EACAH,GAMF,GAFAnB,EAAG6B,MAAMP,GAEW,IAAhBI,EAAQI,IACV,MAAM,IAAIvB,MAAM,0CAGlB,MAAMS,EAAOhB,EAAG+B,WAAWC,OAAON,GAElC,OADAA,EAAQO,SACDjB,CAAI,EAgBIkB,CAAgClC,EAAIP,GAC3C0C,EAAkB,sBAAT3C,EAA+BwB,EAAOoB,KAAKC,MAAMrB,GAEhE/B,EAAI,YAAYS,aAAqBI,KAAKC,MAAQF,QAGlDT,KAAKkD,YAAY,CACf9C,KAAM,OACN2C,SACAzC,YACA6C,SAAUzC,KAAKC,MAAQF,GAE3B,CAAE,MAAOiB,GAEP1B,KAAKkD,YAAY,CACf9C,KAAM,QACNE,YACAR,QAAS4B,EAAM5B,SAEnB,E","sources":["Utils/BackgroundSerializer.worker.js"],"sourcesContent":["/* eslint-env worker */\n// @flow\n\nlet modulePromise /*: ?Promise<libGDevelop>*/ = null;\n\nconst log = (message /*: string */) => {\n  console.log(`[BackgroundSerializerWorker] ${message}`);\n};\n\nconst getLibGDevelop = (versionWithHash /*: string */) => {\n  if (modulePromise) return modulePromise;\n\n  modulePromise = new Promise((resolve, reject) => {\n    try {\n      const url = `/libGD.js?cache-buster=${versionWithHash}`;\n      // Load libGD.js in the worker context.\n      // eslint-disable-next-line no-undef\n      importScripts(url);\n\n      // eslint-disable-next-line no-undef\n      // $FlowFixMe\n      if (typeof initializeGDevelopJs !== 'function') {\n        reject(new Error('Missing initializeGDevelopJs in worker'));\n        return;\n      }\n\n      // eslint-disable-next-line no-undef\n      initializeGDevelopJs({\n        // Override the resolved URL for the .wasm file,\n        // to ensure a new version is fetched when the version changes.\n        locateFile: (path /*: string */, prefix /*: string */) => {\n          // This function is called by Emscripten to locate the .wasm file only.\n          // As the wasm is at the root of the public folder, we can just return\n          // the path to the file.\n          // Plus, on Electron, the prefix seems to be pointing to the root of the\n          // app.asar archive, which is completely wrong.\n          return path + `?cache-buster=${versionWithHash}`;\n        },\n      })\n        .then(module => {\n          resolve(module);\n        })\n        .catch(reject);\n    } catch (error) {\n      reject(error);\n      return;\n    }\n  });\n\n  return modulePromise;\n};\n\nconst unserializeBinarySnapshotToJson = (\n  gd /*: libGDevelop */,\n  binary /*: Uint8Array */\n) => {\n  const binaryArray =\n    binary instanceof Uint8Array ? binary : new Uint8Array(binary);\n  const binarySize = binaryArray.byteLength || binaryArray.length;\n\n  // Allocate memory in Emscripten heap and copy binary data\n  const binaryPtr = gd._malloc(binarySize);\n  gd.HEAPU8.set(binaryArray, binaryPtr);\n\n  const element = gd.BinarySerializer.deserializeBinarySnapshot(\n    binaryPtr,\n    binarySize\n  );\n\n  // Free the input buffer\n  gd._free(binaryPtr);\n\n  if (element.ptr === 0) {\n    throw new Error('Failed to deserialize binary snapshot.');\n  }\n\n  const json = gd.Serializer.toJSON(element);\n  element.delete();\n  return json;\n};\n\n// eslint-disable-next-line no-restricted-globals\nself.onmessage = async (event /*: MessageEvent */) => {\n  // $FlowExpectedError\n  const { type, binary, requestId, versionWithHash } = event.data || {};\n\n  const startTime = Date.now();\n\n  log(`Request #${requestId} received (${type}).`);\n  if (type !== 'SERIALIZE_TO_JSON' && type !== 'SERIALIZE_TO_JS_OBJECT') return;\n\n  try {\n    const gd = await getLibGDevelop(versionWithHash);\n\n    const json = unserializeBinarySnapshotToJson(gd, binary);\n    const result = type === 'SERIALIZE_TO_JSON' ? json : JSON.parse(json);\n\n    log(`Request #${requestId} done in ${Date.now() - startTime}ms.`);\n\n    // eslint-disable-next-line no-restricted-globals\n    self.postMessage({\n      type: 'DONE',\n      result,\n      requestId,\n      duration: Date.now() - startTime,\n    });\n  } catch (error) {\n    // eslint-disable-next-line no-restricted-globals\n    self.postMessage({\n      type: 'ERROR',\n      requestId,\n      message: error.message,\n    });\n  }\n};\n"],"names":["modulePromise","log","message","console","self","onmessage","async","event","type","binary","requestId","versionWithHash","data","startTime","Date","now","gd","Promise","resolve","reject","url","importScripts","initializeGDevelopJs","Error","locateFile","path","prefix","then","module","catch","error","getLibGDevelop","json","binaryArray","Uint8Array","binarySize","byteLength","length","binaryPtr","_malloc","HEAPU8","set","element","BinarySerializer","deserializeBinarySnapshot","_free","ptr","Serializer","toJSON","delete","unserializeBinarySnapshotToJson","result","JSON","parse","postMessage","duration"],"sourceRoot":""}