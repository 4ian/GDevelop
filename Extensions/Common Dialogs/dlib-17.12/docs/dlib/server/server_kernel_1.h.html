<html><!-- Created using the cpp_pretty_printer from the dlib C++ library.  See http://dclib.sf.net for updates. --><head><title>dlib C++ Library - server_kernel_1.h</title></head><body bgcolor='white'><pre>
<font color='#009900'>// Copyright (C) 2003  Davis E. King (davisking@users.sourceforge.net)
</font><font color='#009900'>// License: Boost Software License   See LICENSE.txt for the full license.
</font><font color='#0000FF'>#ifndef</font> DLIB_SERVER_KERNEL_1_
<font color='#0000FF'>#define</font> DLIB_SERVER_KERNEL_1_

<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='server_kernel_abstract.h.html'>server_kernel_abstract.h</a>"

<font color='#009900'>// non-templatable dependencies
</font><font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='../threads.h.html'>../threads.h</a>"
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='../sockets.h.html'>../sockets.h</a>"
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>string<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='../algs.h.html'>../algs.h</a>"
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='../logger.h.html'>../logger.h</a>"


<font color='#0000FF'>namespace</font> dlib
<b>{</b>


    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> set_of_connections
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>class</font> <b><a name='server_kernel_1'></a>server_kernel_1</b>
    <b>{</b>

        <font color='#009900'>/*!
            REQUIREMENTS ON set_of_connections
                implements set/set_kernel_abstract.h or hash_set/hash_set_kernel_abstract.h
                and is a set/hash_set of dlib::connection*


            INITIAL VALUE
                listening_port          == 0
                listening_ip            == ""
                running                 == false
                shutting_down           == false
                cons.size()             == 0
                listening_port_mutex    == a mutex
                listening_ip_mutex      == a mutex
                running_mutex           == a mutex
                running_signaler        == a signaler associated with running_mutex
                shutting_down_mutex     == a mutex
                cons_mutex              == a mutex
                thread_count            == 0
                thread_count_mutex      == a mutex
                thread_count_signaler   == a signaler associated with thread_count_mutex
                thread_count_zero       == a signaler associated with thread_count_mutex
                max_connections         == 0
                max_connections_mutex   == a mutex for max_connections
             
            CONVENTION
                listening_port          == get_listening_port()
                listening_ip            == get_listening_ip()
                running                 == is_running()
                shutting_down           == true while clear() is running.  this
                                           bool is used to tell the thread blocked on
                                           accept that it should terminate
                cons                    == a set containing all open connections
                listening_port_mutex    == a mutex for listening_port
                listening_ip_mutex      == a mutex for listening_ip
                running_mutex           == a mutex for running
                running_signaler        == a signaler for running and
                                           is associated with running_mutex.  it is 
                                           used to signal when running is false
                shutting_down_mutex     == a mutex for shutting_down
                cons_mutex              == a mutex for cons
                thread_count            == the number of threads currently running
                thread_count_mutex      == a mutex for thread_count
                thread_count_signaler   == a signaler for thread_count and
                                           is associated with thread_count_mutex.  it
                                           is used to signal when thread_count is
                                           decremented  
                thread_count_zero       == a signaler for thread_count and
                                           is associated with thread_count_mutex.  it
                                           is used to signal when thread_count becomes
                                           zero
                max_connections         == get_max_connections()
                max_connections_mutex   == a mutex for max_connections
        !*/</font>
        


        <font color='#009900'>// this structure is used to pass parameters to new threads
</font>        <font color='#0000FF'>struct</font> <b><a name='param'></a>param</b>
        <b>{</b>
            <b><a name='param'></a>param</b> <font face='Lucida Console'>(</font>
                server_kernel_1<font color='#5555FF'>&lt;</font>set_of_connections<font color='#5555FF'>&gt;</font><font color='#5555FF'>&amp;</font> server_,
                connection<font color='#5555FF'>&amp;</font> new_connection_
            <font face='Lucida Console'>)</font> :
                server<font face='Lucida Console'>(</font>server_<font face='Lucida Console'>)</font>,
                new_connection<font face='Lucida Console'>(</font>new_connection_<font face='Lucida Console'>)</font>
            <b>{</b><b>}</b>

            server_kernel_1<font color='#5555FF'>&lt;</font>set_of_connections<font color='#5555FF'>&gt;</font><font color='#5555FF'>&amp;</font> server;
            connection<font color='#5555FF'>&amp;</font> new_connection;
        <b>}</b>;
        


        <font color='#0000FF'>public</font>:

            <b><a name='server_kernel_1'></a>server_kernel_1</b><font face='Lucida Console'>(</font>
            <font face='Lucida Console'>)</font>;

            <font color='#0000FF'>virtual</font> ~<b><a name='server_kernel_1'></a>server_kernel_1</b><font face='Lucida Console'>(</font>
            <font face='Lucida Console'>)</font>; 

            <font color='#0000FF'><u>void</u></font> <b><a name='clear'></a>clear</b><font face='Lucida Console'>(</font>
            <font face='Lucida Console'>)</font>;

            <font color='#0000FF'><u>void</u></font> <b><a name='start'></a>start</b> <font face='Lucida Console'>(</font>
            <font face='Lucida Console'>)</font>;

            <font color='#0000FF'><u>bool</u></font> <b><a name='is_running'></a>is_running</b> <font face='Lucida Console'>(</font> 
            <font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>;

            <font color='#0000FF'>const</font> std::string <b><a name='get_listening_ip'></a>get_listening_ip</b> <font face='Lucida Console'>(</font>
            <font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>;

            <font color='#0000FF'><u>int</u></font> <b><a name='get_listening_port'></a>get_listening_port</b> <font face='Lucida Console'>(</font>
            <font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>;

            <font color='#0000FF'><u>void</u></font> <b><a name='set_listening_port'></a>set_listening_port</b> <font face='Lucida Console'>(</font>
                <font color='#0000FF'><u>int</u></font> port
            <font face='Lucida Console'>)</font>;

            <font color='#0000FF'><u>void</u></font> <b><a name='set_listening_ip'></a>set_listening_ip</b> <font face='Lucida Console'>(</font>
                <font color='#0000FF'>const</font> std::string<font color='#5555FF'>&amp;</font> ip
            <font face='Lucida Console'>)</font>;

            <font color='#0000FF'><u>void</u></font> <b><a name='set_max_connections'></a>set_max_connections</b> <font face='Lucida Console'>(</font>
                <font color='#0000FF'><u>int</u></font> max
            <font face='Lucida Console'>)</font>;

            <font color='#0000FF'><u>int</u></font> <b><a name='get_max_connections'></a>get_max_connections</b> <font face='Lucida Console'>(</font>
            <font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>;


        <font color='#0000FF'>private</font>:

            <font color='#0000FF'>virtual</font> <font color='#0000FF'><u>void</u></font> <b><a name='on_connect'></a>on_connect</b> <font face='Lucida Console'>(</font>
                connection<font color='#5555FF'>&amp;</font> new_connection
            <font face='Lucida Console'>)</font><font color='#5555FF'>=</font><font color='#979000'>0</font>;

            <font color='#0000FF'>virtual</font> <font color='#0000FF'><u>void</u></font> <b><a name='on_listening_port_assigned'></a>on_listening_port_assigned</b> <font face='Lucida Console'>(</font>
            <font face='Lucida Console'>)</font> <b>{</b><b>}</b>

            <font color='#0000FF'>const</font> <font color='#0000FF'>static</font> logger sdlog;

            <font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <b><a name='service_connection'></a>service_connection</b><font face='Lucida Console'>(</font>
                <font color='#0000FF'><u>void</u></font><font color='#5555FF'>*</font> item
            <font face='Lucida Console'>)</font>;
            <font color='#009900'>/*!
                requires
                    item is a pointer to a param struct
                ensures
                    services the new connection
                    will take care of closing the connection and 
                    adding the connection to cons when it first starts and
                    remove the connection from cons and signal that it has 
                    done so when it ends
            !*/</font>

            <font color='#009900'>// data members
</font>            <font color='#0000FF'><u>int</u></font> listening_port;
            std::string listening_ip;
            <font color='#0000FF'><u>bool</u></font> running;
            <font color='#0000FF'><u>bool</u></font> shutting_down;
            set_of_connections cons;
            mutex listening_port_mutex;
            mutex listening_ip_mutex;
            mutex running_mutex;
            signaler running_signaler;
            mutex shutting_down_mutex;
            mutex cons_mutex;
            <font color='#0000FF'><u>int</u></font> thread_count;
            mutex thread_count_mutex;
            signaler thread_count_signaler;
            <font color='#0000FF'><u>int</u></font> max_connections;
            mutex max_connections_mutex;
            signaler thread_count_zero;


            <font color='#009900'>// restricted functions
</font>            <b><a name='server_kernel_1'></a>server_kernel_1</b><font face='Lucida Console'>(</font>server_kernel_1<font color='#5555FF'>&lt;</font>set_of_connections<font color='#5555FF'>&gt;</font><font color='#5555FF'>&amp;</font><font face='Lucida Console'>)</font>;   
            server_kernel_1<font color='#5555FF'>&lt;</font>set_of_connections<font color='#5555FF'>&gt;</font><font color='#5555FF'>&amp;</font> <b><a name='operator'></a>operator</b><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>
                server_kernel_1<font color='#5555FF'>&lt;</font>set_of_connections<font color='#5555FF'>&gt;</font><font color='#5555FF'>&amp;</font>
                <font face='Lucida Console'>)</font>;    
    <b>}</b>;

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font><font color='#009900'>// ----------------------------------------------------------------------------------------
</font>    <font color='#009900'>// member function definitions
</font><font color='#009900'>// ----------------------------------------------------------------------------------------
</font><font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> set_of_connections
        <font color='#5555FF'>&gt;</font>
    server_kernel_1<font color='#5555FF'>&lt;</font>set_of_connections<font color='#5555FF'>&gt;</font>::
    <b><a name='server_kernel_1'></a>server_kernel_1</b> <font face='Lucida Console'>(</font>
    <font face='Lucida Console'>)</font> :
        listening_port<font face='Lucida Console'>(</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>,
        running<font face='Lucida Console'>(</font><font color='#979000'>false</font><font face='Lucida Console'>)</font>,
        shutting_down<font face='Lucida Console'>(</font><font color='#979000'>false</font><font face='Lucida Console'>)</font>,
        running_signaler<font face='Lucida Console'>(</font>running_mutex<font face='Lucida Console'>)</font>,
        thread_count<font face='Lucida Console'>(</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>,
        thread_count_signaler<font face='Lucida Console'>(</font>thread_count_mutex<font face='Lucida Console'>)</font>,
        max_connections<font face='Lucida Console'>(</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>,
        thread_count_zero<font face='Lucida Console'>(</font>thread_count_mutex<font face='Lucida Console'>)</font>
    <b>{</b>
    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> set_of_connections
        <font color='#5555FF'>&gt;</font>
    server_kernel_1<font color='#5555FF'>&lt;</font>set_of_connections<font color='#5555FF'>&gt;</font>::
    ~<b><a name='server_kernel_1'></a>server_kernel_1</b> <font face='Lucida Console'>(</font>
    <font face='Lucida Console'>)</font>
    <b>{</b>
        <font color='#BB00BB'>clear</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> set_of_connections
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>int</u></font> server_kernel_1<font color='#5555FF'>&lt;</font>set_of_connections<font color='#5555FF'>&gt;</font>::
    <b><a name='get_max_connections'></a>get_max_connections</b> <font face='Lucida Console'>(</font>
    <font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>
    <b>{</b>
        max_connections_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'><u>int</u></font> temp <font color='#5555FF'>=</font> max_connections;
        max_connections_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> temp;
    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> set_of_connections
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> server_kernel_1<font color='#5555FF'>&lt;</font>set_of_connections<font color='#5555FF'>&gt;</font>::
    <b><a name='set_max_connections'></a>set_max_connections</b> <font face='Lucida Console'>(</font>
        <font color='#0000FF'><u>int</u></font> max
    <font face='Lucida Console'>)</font> 
    <b>{</b>
        max_connections_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        max_connections <font color='#5555FF'>=</font> max;
        max_connections_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> set_of_connections
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> server_kernel_1<font color='#5555FF'>&lt;</font>set_of_connections<font color='#5555FF'>&gt;</font>::
    <b><a name='clear'></a>clear</b> <font face='Lucida Console'>(</font>
    <font face='Lucida Console'>)</font>
    <b>{</b>
        <font color='#009900'>// signal that we are shutting down
</font>        shutting_down_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        shutting_down <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
        shutting_down_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;



        max_connections_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        listening_port_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        listening_ip_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        listening_ip <font color='#5555FF'>=</font> "<font color='#CC0000'></font>";        
        listening_port <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
        max_connections <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
        listening_port_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        listening_ip_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        max_connections_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;


        <font color='#009900'>// tell all the connections to shut down
</font>        cons_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        connection<font color='#5555FF'>*</font> temp;
        <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>cons.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
        <b>{</b>
            cons.<font color='#BB00BB'>remove_any</font><font face='Lucida Console'>(</font>temp<font face='Lucida Console'>)</font>;
            temp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>shutdown</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        cons_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;


        <font color='#009900'>// wait for all the connections to shut down 
</font>        thread_count_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>thread_count <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
        <b>{</b>
            thread_count_zero.<font color='#BB00BB'>wait</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        thread_count_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        



        <font color='#009900'>// wait for the listener to close
</font>        running_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>running <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>true</font><font face='Lucida Console'>)</font>
        <b>{</b>
            running_signaler.<font color='#BB00BB'>wait</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        running_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;



        <font color='#009900'>// signal that the shutdown is complete
</font>        shutting_down_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        shutting_down <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
        shutting_down_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> set_of_connections
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> server_kernel_1<font color='#5555FF'>&lt;</font>set_of_connections<font color='#5555FF'>&gt;</font>::
    <b><a name='start'></a>start</b> <font face='Lucida Console'>(</font>
    <font face='Lucida Console'>)</font>
    <b>{</b>
  
        listener<font color='#5555FF'>*</font> sock;
        <font color='#0000FF'><u>int</u></font> status <font color='#5555FF'>=</font> <font color='#BB00BB'>create_listener</font><font face='Lucida Console'>(</font>sock,listening_port,listening_ip<font face='Lucida Console'>)</font>;

        <font color='#009900'>// if there was an error then clear this object
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>status <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
        <b>{</b>
            max_connections_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            listening_port_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            listening_ip_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            listening_ip <font color='#5555FF'>=</font> "<font color='#CC0000'></font>";        
            listening_port <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            max_connections <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            listening_port_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            listening_ip_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            max_connections_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <b>}</b>

        

        <font color='#009900'>// throw an exception for the error
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>status <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PORTINUSE<font face='Lucida Console'>)</font>
        <b>{</b>
            <font color='#0000FF'>throw</font> dlib::<font color='#BB00BB'>socket_error</font><font face='Lucida Console'>(</font>
                EPORT_IN_USE,
                "<font color='#CC0000'>error occurred in server_kernel_1::start()\nport already in use</font>"
                <font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>status <font color='#5555FF'>=</font><font color='#5555FF'>=</font> OTHER_ERROR<font face='Lucida Console'>)</font>
        <b>{</b>
            <font color='#0000FF'>throw</font> dlib::<font color='#BB00BB'>socket_error</font><font face='Lucida Console'>(</font>
                EOTHER,
                "<font color='#CC0000'>error occurred in server_kernel_1::start()\nunable to crate listener</font>"
                <font face='Lucida Console'>)</font>;            
        <b>}</b>

        running_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        running <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
        running_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

        <font color='#009900'>// determine the listening port
</font>        <font color='#0000FF'><u>bool</u></font> port_assigned <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
        listening_port_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>listening_port <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
        <b>{</b>
            port_assigned <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
            listening_port <font color='#5555FF'>=</font> sock<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>get_listening_port</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        listening_port_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>port_assigned<font face='Lucida Console'>)</font>
            <font color='#BB00BB'>on_listening_port_assigned</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        



        connection<font color='#5555FF'>*</font> client;
        <font color='#0000FF'><u>bool</u></font> exit <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
        <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font> <font color='#979000'>true</font> <font face='Lucida Console'>)</font>
        <b>{</b>


            <font color='#009900'>// accept the next connection
</font>            status <font color='#5555FF'>=</font> sock<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font><font color='#BB00BB'>accept</font><font face='Lucida Console'>(</font>client,<font color='#979000'>1000</font><font face='Lucida Console'>)</font>;


            <font color='#009900'>// if there was an error then quit the loop
</font>            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>status <font color='#5555FF'>=</font><font color='#5555FF'>=</font> OTHER_ERROR<font face='Lucida Console'>)</font>
            <b>{</b>
                <font color='#0000FF'>break</font>;
            <b>}</b>

            shutting_down_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            <font color='#009900'>// if we are shutting down then signal that we should quit the loop
</font>            exit <font color='#5555FF'>=</font> shutting_down;
            shutting_down_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;  


            <font color='#009900'>// if we should be shutting down 
</font>            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>exit<font face='Lucida Console'>)</font>
            <b>{</b>
                <font color='#009900'>// if a connection was opened then close it
</font>                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>status <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                    <font color='#0000FF'>delete</font> client;
                <font color='#0000FF'>break</font>;
            <b>}</b>



            <font color='#009900'>// if the accept timed out
</font>            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>status <font color='#5555FF'>=</font><font color='#5555FF'>=</font> TIMEOUT<font face='Lucida Console'>)</font>
            <b>{</b>
                <font color='#0000FF'>continue</font>;       
            <b>}</b>





            <font color='#009900'>// add this new connection to cons
</font>            cons_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            connection<font color='#5555FF'>*</font> client_temp <font color='#5555FF'>=</font> client;
            <font color='#0000FF'>try</font><b>{</b>cons.<font color='#BB00BB'>add</font><font face='Lucida Console'>(</font>client_temp<font face='Lucida Console'>)</font>;<b>}</b>
            <font color='#0000FF'>catch</font><font face='Lucida Console'>(</font>...<font face='Lucida Console'>)</font>
            <b>{</b> 
                <font color='#0000FF'>delete</font> sock;
                <font color='#0000FF'>delete</font> client;
                cons_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

                <font color='#009900'>// signal that we are not running start() anymore
</font>                running_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                running <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                running_signaler.<font color='#BB00BB'>broadcast</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                running_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;               
                

                <font color='#BB00BB'>clear</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; 
                <font color='#0000FF'>throw</font>;
            <b>}</b>
            cons_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;


            <font color='#009900'>// make a param structure
</font>            param<font color='#5555FF'>*</font> temp;
            <font color='#0000FF'>try</font><b>{</b>
            temp <font color='#5555FF'>=</font> <font color='#0000FF'>new</font> <font color='#BB00BB'>param</font> <font face='Lucida Console'>(</font>
                            <font color='#5555FF'>*</font><font color='#0000FF'>this</font>,
                            <font color='#5555FF'>*</font>client
                            <font face='Lucida Console'>)</font>;
            <b>}</b> <font color='#0000FF'>catch</font> <font face='Lucida Console'>(</font>...<font face='Lucida Console'>)</font> 
            <b>{</b>
                <font color='#0000FF'>delete</font> sock;
                <font color='#0000FF'>delete</font> client;
                running_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                running <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                running_signaler.<font color='#BB00BB'>broadcast</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                running_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                <font color='#BB00BB'>clear</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; 
                <font color='#0000FF'>throw</font>;
            <b>}</b>


            <font color='#009900'>// if create_new_thread failed
</font>            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>create_new_thread</font><font face='Lucida Console'>(</font>service_connection,temp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <b>{</b>
                <font color='#0000FF'>delete</font> temp;
                <font color='#009900'>// close the listening socket
</font>                <font color='#0000FF'>delete</font> sock;

                <font color='#009900'>// close the new connection and remove it from cons
</font>                cons_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                connection<font color='#5555FF'>*</font> ctemp;
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cons.<font color='#BB00BB'>is_member</font><font face='Lucida Console'>(</font>client<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                <b>{</b>
                    cons.<font color='#BB00BB'>remove</font><font face='Lucida Console'>(</font>client,ctemp<font face='Lucida Console'>)</font>;
                <b>}</b>
                <font color='#0000FF'>delete</font> client;
                cons_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;


                <font color='#009900'>// signal that the listener has closed
</font>                running_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                running <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                running_signaler.<font color='#BB00BB'>broadcast</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                running_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

                <font color='#009900'>// make sure the object is cleared
</font>                <font color='#BB00BB'>clear</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

                <font color='#009900'>// throw the exception
</font>                <font color='#0000FF'>throw</font> dlib::<font color='#BB00BB'>thread_error</font><font face='Lucida Console'>(</font>
                    ECREATE_THREAD,
                    "<font color='#CC0000'>error occurred in server_kernel_1::start()\nunable to start thread</font>"
                    <font face='Lucida Console'>)</font>;    
            <b>}</b>
            <font color='#009900'>// if we made the new thread then update thread_count
</font>            <font color='#0000FF'>else</font>
            <b>{</b>
                <font color='#009900'>// increment the thread count
</font>                thread_count_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                <font color='#5555FF'>+</font><font color='#5555FF'>+</font>thread_count;
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>thread_count <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                    thread_count_zero.<font color='#BB00BB'>broadcast</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                thread_count_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            <b>}</b>


            

            <font color='#009900'>// check if we have hit the maximum allowed number of connections
</font>            max_connections_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            <font color='#009900'>// if max_connections is zero or the loop is ending then skip this
</font>            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>max_connections <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <b>{</b>
                <font color='#009900'>// wait for thread_count to be less than max_connections
</font>                thread_count_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>thread_count <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> max_connections<font face='Lucida Console'>)</font>
                <b>{</b>
                    max_connections_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                    thread_count_signaler.<font color='#BB00BB'>wait</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                    max_connections_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;     

                    <font color='#009900'>// if we are shutting down the quit the loop
</font>                    shutting_down_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                    exit <font color='#5555FF'>=</font> shutting_down;
                    shutting_down_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>exit<font face='Lucida Console'>)</font>
                        <font color='#0000FF'>break</font>;
                <b>}</b>
                thread_count_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
            <b>}</b>
            max_connections_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>exit<font face='Lucida Console'>)</font>
            <b>{</b>
                <font color='#0000FF'>break</font>;
            <b>}</b>
        <b>}</b> <font color='#009900'>//while ( true )
</font>

        <font color='#009900'>// close the socket
</font>        <font color='#0000FF'>delete</font> sock;

        <font color='#009900'>// signal that the listener has closed
</font>        running_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        running <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
        running_signaler.<font color='#BB00BB'>broadcast</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        running_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

        <font color='#009900'>// if there was an error with accept then throw an exception
</font>        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>status <font color='#5555FF'>=</font><font color='#5555FF'>=</font> OTHER_ERROR<font face='Lucida Console'>)</font>
        <b>{</b>
            <font color='#009900'>// make sure the object is cleared
</font>            <font color='#BB00BB'>clear</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

            <font color='#009900'>// throw the exception
</font>            <font color='#0000FF'>throw</font> dlib::<font color='#BB00BB'>socket_error</font><font face='Lucida Console'>(</font>
                EOTHER,
             "<font color='#CC0000'>error occurred in server_kernel_1::start()\nlistening socket returned error</font>"
                <font face='Lucida Console'>)</font>;            
        <b>}</b>
    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> set_of_connections
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>bool</u></font> server_kernel_1<font color='#5555FF'>&lt;</font>set_of_connections<font color='#5555FF'>&gt;</font>::
    <b><a name='is_running'></a>is_running</b> <font face='Lucida Console'>(</font>
    <font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>
    <b>{</b>
        running_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'><u>bool</u></font> temp <font color='#5555FF'>=</font> running;
        running_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> temp;
    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> set_of_connections
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>const</font> std::string server_kernel_1<font color='#5555FF'>&lt;</font>set_of_connections<font color='#5555FF'>&gt;</font>::
    <b><a name='get_listening_ip'></a>get_listening_ip</b> <font face='Lucida Console'>(</font>
    <font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>
    <b>{</b>
        listening_ip_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        std::string <font color='#BB00BB'>ip</font><font face='Lucida Console'>(</font>listening_ip<font face='Lucida Console'>)</font>;
        listening_ip_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> ip;
    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> set_of_connections
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>int</u></font> server_kernel_1<font color='#5555FF'>&lt;</font>set_of_connections<font color='#5555FF'>&gt;</font>::
    <b><a name='get_listening_port'></a>get_listening_port</b> <font face='Lucida Console'>(</font>
    <font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>
    <b>{</b>
        listening_port_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'><u>int</u></font> port <font color='#5555FF'>=</font> listening_port;
        listening_port_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;        
        <font color='#0000FF'>return</font> port;
    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> set_of_connections
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> server_kernel_1<font color='#5555FF'>&lt;</font>set_of_connections<font color='#5555FF'>&gt;</font>::
    <b><a name='set_listening_port'></a>set_listening_port</b> <font face='Lucida Console'>(</font>
        <font color='#0000FF'><u>int</u></font> port
    <font face='Lucida Console'>)</font>
    <b>{</b>
        listening_port_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        listening_port <font color='#5555FF'>=</font> port;
        listening_port_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> set_of_connections
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> server_kernel_1<font color='#5555FF'>&lt;</font>set_of_connections<font color='#5555FF'>&gt;</font>::
    <b><a name='set_listening_ip'></a>set_listening_ip</b> <font face='Lucida Console'>(</font>
        <font color='#0000FF'>const</font> std::string<font color='#5555FF'>&amp;</font> ip
    <font face='Lucida Console'>)</font>
    <b>{</b>
        listening_ip_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        listening_ip <font color='#5555FF'>=</font> ip;
        listening_ip_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font><font color='#009900'>// ----------------------------------------------------------------------------------------
</font>    <font color='#009900'>// static member function definitions
</font><font color='#009900'>// ----------------------------------------------------------------------------------------
</font><font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> soc
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>const</font> logger server_kernel_1<font color='#5555FF'>&lt;</font>soc<font color='#5555FF'>&gt;</font>::<b><a name='sdlog'></a>sdlog</b><font face='Lucida Console'>(</font>"<font color='#CC0000'>dlib.server</font>"<font face='Lucida Console'>)</font>;

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> soc
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> server_kernel_1<font color='#5555FF'>&lt;</font>soc<font color='#5555FF'>&gt;</font>::
    <b><a name='service_connection'></a>service_connection</b><font face='Lucida Console'>(</font>
        <font color='#0000FF'><u>void</u></font><font color='#5555FF'>*</font> item
    <font face='Lucida Console'>)</font>
    <b>{</b>
        param<font color='#5555FF'>&amp;</font> p <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#0000FF'>reinterpret_cast</font><font color='#5555FF'>&lt;</font>param<font color='#5555FF'>*</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>item<font face='Lucida Console'>)</font>;


        p.server.<font color='#BB00BB'>on_connect</font><font face='Lucida Console'>(</font>p.new_connection<font face='Lucida Console'>)</font>;


        <font color='#009900'>// remove this connection from cons and close it
</font>        p.server.cons_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        connection<font color='#5555FF'>*</font> temp;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>p.server.cons.<font color='#BB00BB'>is_member</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>p.new_connection<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            p.server.cons.<font color='#BB00BB'>remove</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>p.new_connection,temp<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>try</font><b>{</b> <font color='#BB00BB'>close_gracefully</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>p.new_connection<font face='Lucida Console'>)</font>; <b>}</b> 
        <font color='#0000FF'>catch</font> <font face='Lucida Console'>(</font>...<font face='Lucida Console'>)</font> <b>{</b> sdlog <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> LERROR <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>close_gracefully() threw</font>"; <b>}</b> 
        p.server.cons_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

        <font color='#009900'>// decrement the thread count and signal if it is now zero
</font>        p.server.thread_count_mutex.<font color='#BB00BB'>lock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#5555FF'>-</font><font color='#5555FF'>-</font>p.server.thread_count;
        p.server.thread_count_signaler.<font color='#BB00BB'>broadcast</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>p.server.thread_count <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            p.server.thread_count_zero.<font color='#BB00BB'>broadcast</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
        p.server.thread_count_mutex.<font color='#BB00BB'>unlock</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;

        <font color='#0000FF'>delete</font> <font color='#5555FF'>&amp;</font>p;


    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
<b>}</b>

<font color='#0000FF'>#endif</font> <font color='#009900'>// DLIB_SERVER_KERNEL_1_
</font>

</pre></body></html>