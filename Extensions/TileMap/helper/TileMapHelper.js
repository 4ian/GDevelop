!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.TileMapHelper=t():e.TileMapHelper=t()}("undefined"!=typeof self?self:this,(function(){return(()=>{"use strict";var e={359:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},271:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PixiTileMapHelper=void 0;const l=i(470),a=i(595);var s=GlobalPIXIModule.PIXI;t.PixiTileMapHelper=class{static parseAtlas(e,t,i){if(!e.tiledversion)return console.warn("The loaded Tiled map does not contain a 'tiledversion' key. Are you sure this file has been exported from Tiled (mapeditor.org)?"),null;if(!e.tilesets.length||"source"in e.tilesets[0])return console.warn("The loaded Tiled map seems not to contain any tileset data (nothing in 'tilesets' key)."),null;const{tilewidth:l,tileheight:o,tilecount:r,tiles:n,image:d,columns:p,spacing:c,margin:h}=e.tilesets[0];t||(t=i(d));const g=r/p,u=l*p+c*(p-1)+2*h,f=o*g+c*(g-1)+2*h;if(1!==t.width&&u!==t.width||1!==t.height&&f!==t.height){const e=u+"x"+f,i=t.width+"x"+t.height;return console.warn("It seems the atlas file was resized, which is not supported. It should be "+e+"px, but it's "+i+" px."),null}const y=new a.TileTextureCache;for(let e=0;e<r;e++){const i=h+Math.floor(e%p)*(l+c),a=h+Math.floor(e/p)*(o+c);try{const r=new s.Rectangle(i,a,l,o),n=new s.Texture(t,r);y.setTexture(e,!1,!1,!1,n)}catch(e){console.error("An error occurred while creating a PIXI.Texture to be used in a TileMap:",e)}}return y}static updatePixiTileMap(e,t,i,a,s){if(e){e.clear();for(const o of t.getLayers()){if("index"===a&&s!==o.id)return;if(o instanceof l.EditableObjectLayer){const t=o;for(const l of t.objects){const a=i.findTileTexture(l.getTileId(),l.isFlippedHorizontally(),l.isFlippedVertically(),l.isFlippedDiagonally());a&&e.addFrame(a,l.x,l.y-t.tileMap.getTileHeight())}}else if(o instanceof l.EditableTileMapLayer){const t=o;for(let l=0;l<t.tileMap.getDimensionY();l++)for(let a=0;a<t.tileMap.getDimensionX();a++){const s=t.tileMap.getTileWidth()*a,o=t.tileMap.getTileHeight()*l,r=t.get(a,l),n=i.findTileTexture(r,t.isFlippedHorizontally(a,l),t.isFlippedVertically(a,l),t.isFlippedDiagonally(a,l));n&&(e.addFrame(n,s,o),t.tileMap.getTileDefinition(r))}}}}}static updatePixiCollisionMask(e,t,i,a,s,o,r,n,d,p){if(e){e.clear();for(const c of t.getLayers()){if("index"===i&&a!==c.id)return;const h=t.getTileWidth(),g=t.getTileHeight();if(c instanceof l.EditableTileMapLayer){const t=c;for(let i=0;i<t.tileMap.getDimensionY();i++)for(let l=0;l<t.tileMap.getDimensionX();l++){const a=h*l,c=g*i,u=t.get(l,i),f=t.isFlippedHorizontally(l,i),y=t.isFlippedVertically(l,i),T=t.isFlippedDiagonally(l,i),M=t.tileMap.getTileDefinition(u);if(M&&M.getTag()===s){e.lineStyle(o,r,n);for(const t of M.getPolygons())if(0!==t.length){e.beginFill(d,p);for(let i=0;i<t.length;i++){let l=t[i][0],s=t[i][1];if(f&&(l=h-l),y&&(s=g-s),T){const e=l;l=s,s=e}0===i?e.moveTo(a+l,c+s):e.lineTo(a+l,c+s)}e.closePath(),e.endFill()}}}}}}}}},44:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ResourceCache=void 0,t.ResourceCache=class{constructor(){this._cachedValues=new Map,this._callbacks=new Map}getOrLoad(e,t,i){{const t=this._cachedValues.get(e);if(t)return void i(t)}{const t=this._callbacks.get(e);if(t)return void t.push(i);this._callbacks.set(e,[i])}t((t=>{t&&this._cachedValues.set(e,t);const i=this._callbacks.get(e);this._callbacks.delete(e);for(const e of i)e(t)}))}}},315:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TileMapManager=void 0;const l=i(271),a=i(44),s=i(47);class o{constructor(){this._tileMapCache=new a.ResourceCache,this._textureCacheCaches=new a.ResourceCache}static getManager(e){return e.tileMapCollisionMaskManager||(e.tileMapCollisionMaskManager=new o),e.tileMapCollisionMaskManager}getOrLoadTileMap(e,t,i,l,a){const o=t+"|"+i;this._tileMapCache.getOrLoad(o,(a=>{e(t,i,(e=>{if(!e)return void a(null);const t=s.TiledTileMapLoader.load(l,e);a(t)}))}),a)}getOrLoadTextureCache(e,t,i,a,s,o){const r=a+"|"+s+"|"+i;this._textureCacheCaches.getOrLoad(r,(o=>{e(a,s,(e=>{if(!e)return void o(null);const a=i?t(i):null,s=l.PixiTileMapHelper.parseAtlas(e,a,t);o(s)}))}),o)}}t.TileMapManager=o},470:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CollisionTileDefinition=t.EditableTileMapLayer=t.TileObject=t.EditableObjectLayer=t.EditableTileMap=void 0,t.EditableTileMap=class{constructor(e,t,i,l,a){console.log("tile dimension: "+e+" "+t),this.tileWidth=e,this.tileHeight=t,this.dimX=i,this.dimY=l,this._tileSet=a,this._layers=[]}getWidth(){return this.tileWidth*this.dimX}getHeight(){return this.tileHeight*this.dimY}getTileHeight(){return this.tileWidth}getTileWidth(){return this.tileHeight}getDimensionX(){return this.dimX}getDimensionY(){return this.dimY}getTileDefinition(e){return this._tileSet.get(e)}addTileLayer(e){const t=new l(this,e);return this._layers.push(t),t}addObjectLayer(e){const t=new i(this,e);return this._layers.push(t),t}getLayers(){return this._layers}pointIsInsideTile(e,t,i){const l=Math.floor(e/this.tileWidth),a=Math.floor(t/this.tileHeight);for(const e of this._layers){const t=e;if(!t)continue;const s=t.get(l,a);if(!s)return!1;if(this._tileSet.get(s).getTag()===i)return!0}return!1}};class i{constructor(e,t){this.tileMap=e,this.id=t,this.objects=[]}add(e){this.objects.push(e)}}t.EditableObjectLayer=i,t.TileObject=class{constructor(e,t,i){this.tileId=i,this.x=e,this.y=t}getTileId(){return this.tileId&l.tileIdMask}setFlippedHorizontally(e){let t=this.tileId;t&=~l.flippedHorizontallyFlag,e&&(t|=l.flippedHorizontallyFlag),this.tileId=t}setFlippedVertically(e){let t=this.tileId;t&=~l.flippedVerticallyFlag,e&&(t|=l.flippedVerticallyFlag),this.tileId=t}setFlippedDiagonally(e){let t=this.tileId;t&=~l.flippedDiagonallyFlag,e&&(t|=l.flippedDiagonallyFlag),this.tileId=t}isFlippedHorizontally(){return 0!=(this.tileId&l.flippedHorizontallyFlag)}isFlippedVertically(){return 0!=(this.tileId&l.flippedVerticallyFlag)}isFlippedDiagonally(){return 0!=(this.tileId&l.flippedDiagonallyFlag)}};class l{constructor(e,t){this.tileMap=e,this.id=t,this._tiles=[],this._tiles.length=this.tileMap.getDimensionY();for(let e=0;e<this._tiles.length;e++)this._tiles[e]=new Int32Array(this.tileMap.getDimensionX())}setTile(e,t,i){this.tileMap.getTileDefinition(i)&&(this._tiles[t][e]=i+1)}setFlippedHorizontally(e,t,i){let a=this._tiles[t][e];a&=~l.flippedHorizontallyFlag,i&&(a|=l.flippedHorizontallyFlag),this._tiles[t][e]=a}setFlippedVertically(e,t,i){let a=this._tiles[t][e];a&=~l.flippedVerticallyFlag,i&&(a|=l.flippedVerticallyFlag),this._tiles[t][e]=a}setFlippedDiagonally(e,t,i){let a=this._tiles[t][e];a&=~l.flippedDiagonallyFlag,i&&(a|=l.flippedDiagonallyFlag),this._tiles[t][e]=a}isFlippedHorizontally(e,t){return 0!=(this._tiles[t][e]&l.flippedHorizontallyFlag)}isFlippedVertically(e,t){return 0!=(this._tiles[t][e]&l.flippedVerticallyFlag)}isFlippedDiagonally(e,t){return 0!=(this._tiles[t][e]&l.flippedDiagonallyFlag)}get(e,t){const i=this._tiles[t];if(i&&0!==i[e])return i[e]-1&l.tileIdMask}dimX(){return 0===this._tiles.length?0:this._tiles[0].length}dimY(){return this._tiles.length}getWidth(){return this.tileMap.getWidth()}getHeight(){return this.tileMap.getHeight()}}t.EditableTileMapLayer=l,l.flippedHorizontallyFlag=2147483648,l.flippedVerticallyFlag=1073741824,l.flippedDiagonallyFlag=536870912,l.tileIdMask=~(l.flippedHorizontallyFlag|l.flippedVerticallyFlag|l.flippedDiagonallyFlag),t.CollisionTileDefinition=class{constructor(e,t=""){this.polygons=e,this.tag=t}getTag(){return this.tag}getPolygons(){return this.polygons}}},595:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TileTextureCache=void 0;var i=GlobalPIXIModule.PIXI;class l{constructor(){this._textures=new Map}setTexture(e,t,i,l,a){let s=this._getGlobalId(e,t,i,l);this._textures.set(s,a)}findTileTexture(e,t,l,a){let s=this._getGlobalId(e,t,l,a);if(0===s)return;if(this._textures.has(s))return this._textures.get(s);const o=this._textures.get(e);if(!o)return;const r=o.frame.clone(),n=o.orig.clone();if(a){const e=n.width;n.width=n.height,n.height=e}const d=n.clone();let p=0;a?(p=10,!t&&l?p=2:t&&!l?p=6:t&&l&&(p=14)):(p=0,!t&&l?p=8:t&&!l?p=12:t&&l&&(p=4));const c=new i.Texture(o.baseTexture,r,n,d,p);return this._textures.set(s,c),c}_getGlobalId(e,t,i,a){let s=e;return t&&(s|=l.flippedHorizontallyFlag),i&&(s|=l.flippedVerticallyFlag),a&&(s|=l.flippedDiagonallyFlag),s}}t.TileTextureCache=l,l.flippedHorizontallyFlag=2147483648,l.flippedVerticallyFlag=1073741824,l.flippedDiagonallyFlag=536870912},234:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.extractTileUidFlippedStates=t.decodeBase64LayerData=void 0,t.decodeBase64LayerData=(e,t)=>{const{data:i,compression:l}=t;if(!i)return i;let a=4;const s=[];let o=atob(i).split("").map((function(e){return e.charCodeAt(0)}));try{const t=(e,t)=>e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24)>>>0;if("zlib"===l){const i=new Uint8Array(o),l=e.inflate(i);for(;a<=l.length;)s.push(t(l,a-4)),a+=4}else{if("zstd"===l)return console.error("Zstandard compression is not supported for layers in a Tilemap. Use instead zlib compression or no compression."),null;for(;a<=o.length;)s.push(t(o,a-4)),a+=4}return s}catch(e){return console.error("Failed to decompress and unzip base64 layer.data string",e),null}},t.extractTileUidFlippedStates=e=>({id:536870911&e,flippedHorizontally:!!(2147483648&e),flippedVertically:!!(1073741824&e),flippedDiagonally:!!(536870912&e)})},47:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TiledTileMapLoader=void 0;const l=i(234),a=i(470);t.TiledTileMapLoader=class{static load(e,t){const i=new Map;for(const e of t.tilesets[0].tiles){const t=[];if(e.objectgroup)for(const i of e.objectgroup.objects){let e=null;e=i.polygon?i.polygon.map((e=>[e.x,e.y])):[[i.x,i.y],[i.x,i.y+i.height],[i.x+i.width,i.y+i.height],[i.x+i.width,i.y]],t.push(e)}i.set(e.id,new a.CollisionTileDefinition(t,e.type))}for(let e=0;e<t.tilesets[0].tilecount;e++)i.has(e)||i.set(e,new a.CollisionTileDefinition([],""));const s=new a.EditableTileMap(t.tilewidth,t.tileheight,t.width,t.height,i);for(const i of t.layers)if(i.visible)if("objectgroup"===i.type){const e=s.addObjectLayer(i.id);for(const t of i.objects){if(!t.visible)continue;const i=l.extractTileUidFlippedStates(t.gid),s=new a.TileObject(t.x,t.y,i.id);e.add(s),s.setFlippedHorizontally(i.flippedHorizontally),s.setFlippedVertically(i.flippedVertically),s.setFlippedDiagonally(i.flippedDiagonally)}}else if("tilelayer"===i.type){let t=0,a=null;if("base64"===i.encoding?(a=l.decodeBase64LayerData(e,i),a||console.warn("Failed to uncompress layer.data")):a=i.data,a){const e=s.addTileLayer(i.id);for(let s=0;s<i.height;s++)for(let o=0;o<i.width;o++){const i=a[t],r=l.extractTileUidFlippedStates(i);e.setTile(o,s,r.id-1),e.setFlippedHorizontally(o,s,r.flippedHorizontally),e.setFlippedVertically(o,s,r.flippedVertically),e.setFlippedDiagonally(o,s,r.flippedDiagonally),t+=1}}}return s}}},303:function(e,t,i){var l=this&&this.__createBinding||(Object.create?function(e,t,i,l){void 0===l&&(l=i),Object.defineProperty(e,l,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,l){void 0===l&&(l=i),e[l]=t[i]}),a=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||l(t,e,i)};Object.defineProperty(t,"__esModule",{value:!0}),t.PixiTileMapHelper=t.TileMapManager=void 0;const s=i(315);Object.defineProperty(t,"TileMapManager",{enumerable:!0,get:function(){return s.TileMapManager}});const o=i(271);Object.defineProperty(t,"PixiTileMapHelper",{enumerable:!0,get:function(){return o.PixiTileMapHelper}}),a(i(359),t),t.default=s.TileMapManager}},t={};return function i(l){var a=t[l];if(void 0!==a)return a.exports;var s=t[l]={exports:{}};return e[l].call(s.exports,s,s.exports,i),s.exports}(303)})()}));
//# sourceMappingURL=TileMapHelper.js.map