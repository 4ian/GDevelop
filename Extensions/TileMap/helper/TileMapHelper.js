!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TileMapHelper={})}(this,(function(t){"use strict";var e=function(t,i){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},e(t,i)};function i(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}function r(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],r=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}var n=function(){function t(t,e,i,r,n){this.tileWidth=t,this.tileHeight=e,this.dimX=i,this.dimY=r,this._tileSet=n,this._layers=[]}return t.prototype.getWidth=function(){return this.tileWidth*this.dimX},t.prototype.getHeight=function(){return this.tileHeight*this.dimY},t.prototype.getTileHeight=function(){return this.tileWidth},t.prototype.getTileWidth=function(){return this.tileHeight},t.prototype.getDimensionX=function(){return this.dimX},t.prototype.getDimensionY=function(){return this.dimY},t.prototype.getTileDefinition=function(t){return this._tileSet.get(t)},t.prototype.getTileDefinitions=function(){return this._tileSet.values()},t.prototype.addTileLayer=function(t){var e=new p(this,t);return this._layers.push(e),e},t.prototype.addObjectLayer=function(t){var e=new o(this,t);return this._layers.push(e),e},t.prototype.getLayers=function(){return this._layers},t.prototype.pointIsInsideTile=function(t,e,i){var n,l,o=Math.floor(t/this.tileWidth),a=Math.floor(e/this.tileHeight);try{for(var s=r(this._layers),p=s.next();!p.done;p=s.next()){var u=p.value;if(u){var f=u.get(o,a);if(void 0===f)return!1;if(this._tileSet.get(f).hasTag(i))return!0}}}catch(t){n={error:t}}finally{try{p&&!p.done&&(l=s.return)&&l.call(s)}finally{if(n)throw n.error}}return!1},t}(),l=function(){function t(t,e){this.visible=!0,this.tileMap=t,this.id=e}return t.prototype.setVisible=function(t){this.visible=t},t.prototype.isVisible=function(){return this.visible},t}(),o=function(t){function e(e,i){var r=t.call(this,e,i)||this;return r.objects=[],r}return i(e,t),e.prototype.add=function(t){this.objects.push(t)},e}(l),a=function(){function t(t,e,i){this.tileId=i,this.x=t,this.y=e}return t.prototype.getTileId=function(){return s.getTileId(this.tileId)},t.prototype.setFlippedHorizontally=function(t){this.tileId=s.setFlippedHorizontally(this.tileId,t)},t.prototype.setFlippedVertically=function(t){this.tileId=s.setFlippedVertically(this.tileId,t)},t.prototype.setFlippedDiagonally=function(t){this.tileId=s.setFlippedDiagonally(this.tileId,t)},t.prototype.isFlippedHorizontally=function(){return s.isFlippedHorizontally(this.tileId)},t.prototype.isFlippedVertically=function(){return s.isFlippedVertically(this.tileId)},t.prototype.isFlippedDiagonally=function(){return s.isFlippedDiagonally(this.tileId)},t}(),s=function(){function t(){}return t.getTileId=function(e){return e&t.tileIdMask},t.setFlippedHorizontally=function(e,i){return e&=~t.flippedHorizontallyFlag,i&&(e|=t.flippedHorizontallyFlag),e},t.setFlippedVertically=function(e,i){return e&=~t.flippedVerticallyFlag,i&&(e|=t.flippedVerticallyFlag),e},t.setFlippedDiagonally=function(e,i){return e&=~t.flippedDiagonallyFlag,i&&(e|=t.flippedDiagonallyFlag),e},t.isFlippedHorizontally=function(e){return 0!=(e&t.flippedHorizontallyFlag)},t.isFlippedVertically=function(e){return 0!=(e&t.flippedVerticallyFlag)},t.isFlippedDiagonally=function(e){return 0!=(e&t.flippedDiagonallyFlag)},t.flippedHorizontallyFlag=2147483648,t.flippedVerticallyFlag=1073741824,t.flippedDiagonallyFlag=536870912,t.tileIdMask=~(t.flippedHorizontallyFlag|t.flippedVerticallyFlag|t.flippedDiagonallyFlag),t}(),p=function(t){function e(e,i){var r=t.call(this,e,i)||this;r._tiles=[],r._tiles.length=r.tileMap.getDimensionY();for(var n=0;n<r._tiles.length;n++)r._tiles[n]=new Int32Array(r.tileMap.getDimensionX());return r}return i(e,t),e.prototype.setTile=function(t,e,i){if(!this.tileMap.getTileDefinition(i))throw new Error("Invalid tile definition index: ".concat(i));this._tiles[e][t]=i+1},e.prototype.removeTile=function(t,e){this._tiles[e][t]=0},e.prototype.setFlippedHorizontally=function(t,e,i){var r=this._tiles[e][t];0!==r&&(this._tiles[e][t]=s.setFlippedHorizontally(r,i))},e.prototype.setFlippedVertically=function(t,e,i){var r=this._tiles[e][t];0!==r&&(this._tiles[e][t]=s.setFlippedVertically(r,i))},e.prototype.setFlippedDiagonally=function(t,e,i){var r=this._tiles[e][t];0!==r&&(this._tiles[e][t]=s.setFlippedDiagonally(r,i))},e.prototype.isFlippedHorizontally=function(t,e){return s.isFlippedHorizontally(this._tiles[e][t])},e.prototype.isFlippedVertically=function(t,e){return s.isFlippedVertically(this._tiles[e][t])},e.prototype.isFlippedDiagonally=function(t,e){return s.isFlippedDiagonally(this._tiles[e][t])},e.prototype.get=function(t,e){var i=this._tiles[e];if(i&&0!==i[t])return s.getTileId(i[t]-1)},e.prototype.getDimensionX=function(){return 0===this._tiles.length?0:this._tiles[0].length},e.prototype.getDimensionY=function(){return this._tiles.length},e.prototype.getWidth=function(){return this.tileMap.getWidth()},e.prototype.getHeight=function(){return this.tileMap.getHeight()},e}(l),u=function(){function t(t){this.taggedHitBoxes=[],this.animationLength=t}return t.prototype.add=function(t,e){var i=this.taggedHitBoxes.find((function(e){return e.tag===t}));i||(i={tag:t,polygons:[]},this.taggedHitBoxes.push(i)),i.polygons.push(e)},t.prototype.hasTag=function(t){return this.taggedHitBoxes.some((function(e){return e.tag===t}))},t.prototype.getHitBoxes=function(t){var e=this.taggedHitBoxes.find((function(e){return e.tag===t}));return e&&e.polygons},t.prototype.getAnimationLength=function(){return this.animationLength},t}(),f=function(){function t(){this._cachedValues=new Map,this._callbacks=new Map}return t.prototype.getOrLoad=function(t,e,i){var n=this,l=this._cachedValues.get(t);if(l)i(l);else{var o=this._callbacks.get(t);o?o.push(i):(this._callbacks.set(t,[i]),e((function(e){var i,l;e&&n._cachedValues.set(t,e);var o=n._callbacks.get(t);n._callbacks.delete(t);try{for(var a=r(o),s=a.next();!s.done;s=a.next()){(0,s.value)(e)}}catch(t){i={error:t}}finally{try{s&&!s.done&&(l=a.return)&&l.call(a)}finally{if(i)throw i.error}}})))}},t}(),d=function(t,e){var i=e.data,r=e.compression;if(!i)return i;var n=4,l=[],o=atob(i).split("").map((function(t){return t.charCodeAt(0)}));try{var a=function(t,e){return t[e]+(t[e+1]<<8)+(t[e+2]<<16)+(t[e+3]<<24)>>>0};if("zlib"===r)for(var s=new Uint8Array(o),p=t.inflate(s);n<=p.length;)l.push(a(p,n-4)),n+=4;else{if("zstd"===r)return console.error("Zstandard compression is not supported for layers in a Tilemap. Use instead zlib compression or no compression."),null;for(;n<=o.length;)l.push(a(o,n-4)),n+=4}return l}catch(t){return console.error("Failed to decompress and unzip base64 layer.data string",t),null}},c=function(t){var e=2147483648,i=1073741824,r=536870912;return{id:536870911&t,flippedHorizontally:!!(t&e),flippedVertically:!!(t&i),flippedDiagonally:!!(t&r)}},h=function(){function t(){}return t.load=function(t,e){var i,l,o,s,p,f,h,y;if(!e.tiledversion)return console.warn("The loaded Tiled map does not contain a 'tiledversion' key. Are you sure this file has been exported from Tiled (mapeditor.org)?"),null;var g=new Map,v=e.tilesets[0];if(v.tiles)try{for(var x=r(v.tiles),F=x.next();!F.done;F=x.next()){var T=F.value,b=new u(T.animation?T.animation.length:0);if(T.objectgroup){var _=function(t){var e=null;if(t.polygon){var i=t.rotation*Math.PI/180,r=Math.cos(i),n=Math.sin(i);-1!==r&&1!==r||(n=0),-1!==n&&1!==n||(r=0),e=t.polygon.map((function(e){return[t.x+e.x*r-e.y*n,t.y+e.x*n+e.y*r]}))}else e=[[t.x,t.y],[t.x,t.y+t.height],[t.x+t.width,t.y+t.height],[t.x+t.width,t.y]];b.add(t.type||T.type,e)};try{for(var m=(o=void 0,r(T.objectgroup.objects)),w=m.next();!w.done;w=m.next()){_(X=w.value)}}catch(t){o={error:t}}finally{try{w&&!w.done&&(s=m.return)&&s.call(m)}finally{if(o)throw o.error}}}g.set(T.id,b)}}catch(t){i={error:t}}finally{try{F&&!F.done&&(l=x.return)&&l.call(x)}finally{if(i)throw i.error}}for(var M=0;M<v.tilecount;M++){var H=v.firstgid-1+M;g.has(H)||g.set(H,new u(0))}var D=new n(e.tilewidth,e.tileheight,e.width,e.height,g);try{for(var I=r(e.layers),V=I.next();!V.done;V=I.next()){var z=V.value;if("objectgroup"===z.type){var L=D.addObjectLayer(z.id);L.setVisible(z.visible);try{for(var j=(h=void 0,r(z.objects)),k=j.next();!k.done;k=j.next()){var C=k.value;if(C.visible){var O=c(C.gid),X=new a(C.x,C.y,O.id);L.add(X),X.setFlippedHorizontally(O.flippedHorizontally),X.setFlippedVertically(O.flippedVertically),X.setFlippedDiagonally(O.flippedDiagonally)}}}catch(t){h={error:t}}finally{try{k&&!k.done&&(y=j.return)&&y.call(j)}finally{if(h)throw h.error}}}else if("tilelayer"===z.type){var A=0,P=null;if("base64"===z.encoding?(P=d(t,z))||console.warn("Failed to uncompress layer.data"):P=z.data,P){var W=D.addTileLayer(z.id);W.setVisible(z.visible);for(var S=0;S<z.height;S++)for(var Y=0;Y<z.width;Y++){var B=P[A],E=c(B);E.id>0&&(W.setTile(Y,S,E.id-1),W.setFlippedHorizontally(Y,S,E.flippedHorizontally),W.setFlippedVertically(Y,S,E.flippedVertically),W.setFlippedDiagonally(Y,S,E.flippedDiagonally)),A+=1}}}}}catch(t){p={error:t}}finally{try{V&&!V.done&&(f=I.return)&&f.call(I)}finally{if(p)throw p.error}}return D},t}(),y=GlobalPIXIModule.PIXI,g=function(){function t(){this._textures=new Map}return t.prototype.setTexture=function(t,e,i,r,n){var l=this._getGlobalId(t,e,i,r);this._textures.set(l,n)},t.prototype.findTileTexture=function(t,e,i,r){var n=this._getGlobalId(t,e,i,r);if(0!==n){if(this._textures.has(n))return this._textures.get(n);var l=this._textures.get(t);if(l){var o=l.frame.clone(),a=l.orig.clone();if(r){var s=a.width;a.width=a.height,a.height=s}var p=a.clone(),u=0;r?(u=10,!e&&i?u=2:e&&!i?u=6:e&&i&&(u=14)):(u=0,!e&&i?u=8:e&&!i?u=12:e&&i&&(u=4));var f=new y.Texture(l.baseTexture,o,a,p,u);return this._textures.set(n,f),f}}},t.prototype._getGlobalId=function(e,i,r,n){var l=e;return i&&(l|=t.flippedHorizontallyFlag),r&&(l|=t.flippedVerticallyFlag),n&&(l|=t.flippedDiagonallyFlag),l},t.flippedHorizontallyFlag=2147483648,t.flippedVerticallyFlag=1073741824,t.flippedDiagonallyFlag=536870912,t}(),v=GlobalPIXIModule.PIXI,x=function(){function t(){}return t.parseAtlas=function(t,e,i){if(!t.tiledversion)return console.warn("The loaded Tiled map does not contain a 'tiledversion' key. Are you sure this file has been exported from Tiled (mapeditor.org)?"),null;if(!t.tilesets.length||"source"in t.tilesets[0])return console.warn("The loaded Tiled map seems not to contain any tileset data (nothing in 'tilesets' key)."),null;var r=t.tilesets[0],n=r.tilewidth,l=r.tileheight,o=r.tilecount;r.tiles;var a=r.image,s=r.columns,p=r.spacing,u=r.margin;e||(e=i(a));var f=o/s,d=n*s+p*(s-1)+2*u,c=l*f+p*(f-1)+2*u;if(1!==e.width&&d!==e.width||1!==e.height&&c!==e.height){var h=d+"x"+c,y=e.width+"x"+e.height;return console.warn("It seems the atlas file was resized, which is not supported. It should be "+h+"px, but it's "+y+" px."),null}for(var x=new g,F=0;F<o;F++){var T=u+Math.floor(F%s)*(n+p),b=u+Math.floor(F/s)*(l+p);try{var _=new v.Rectangle(T,b,n,l),m=new v.Texture(e,_);x.setTexture(F,!1,!1,!1,m)}catch(t){console.error("An error occurred while creating a PIXI.Texture to be used in a TileMap:",t)}}return x},t.updatePixiTileMap=function(t,e,i,n,l){var a,s,u,f;if(t){t.clear();try{for(var d=r(e.getLayers()),c=d.next();!c.done;c=d.next()){var h=c.value;if("index"===n&&l!==h.id||"visible"===n&&!h.isVisible())return;if(h instanceof o){var y=h;try{for(var g=(u=void 0,r(y.objects)),v=g.next();!v.done;v=g.next()){var x=v.value,F=i.findTileTexture(x.getTileId(),x.isFlippedHorizontally(),x.isFlippedVertically(),x.isFlippedDiagonally());F&&t.addFrame(F,x.x,x.y-y.tileMap.getTileHeight())}}catch(t){u={error:t}}finally{try{v&&!v.done&&(f=g.return)&&f.call(g)}finally{if(u)throw u.error}}}else if(h instanceof p)for(var T=h,b=0;b<T.tileMap.getDimensionY();b++)for(var _=0;_<T.tileMap.getDimensionX();_++){var m=T.tileMap.getTileWidth(),w=m*_,M=T.tileMap.getTileHeight()*b,H=T.get(_,b),D=i.findTileTexture(H,T.isFlippedHorizontally(_,b),T.isFlippedVertically(_,b),T.isFlippedDiagonally(_,b));if(D){var I=t.addFrame(D,w,M),V=T.tileMap.getTileDefinition(H);V&&V.getAnimationLength()>0&&I.tileAnimX(m,V.getAnimationLength())}}}}catch(t){a={error:t}}finally{try{c&&!c.done&&(s=d.return)&&s.call(d)}finally{if(a)throw a.error}}}},t.updatePixiCollisionMask=function(t,e,i,n,l,o,a,s){var u,f,d,c;if(t){t.clear();try{for(var h=r(e.getLayers()),y=h.next();!y.done;y=h.next()){var g=y.value,v=e.getTileWidth(),x=e.getTileHeight();if(g instanceof p)for(var F=g,T=0;T<F.tileMap.getDimensionY();T++)for(var b=0;b<F.tileMap.getDimensionX();b++){var _=v*b,m=x*T,w=F.get(b,T),M=F.isFlippedHorizontally(b,T),H=F.isFlippedVertically(b,T),D=F.isFlippedDiagonally(b,T),I=F.tileMap.getTileDefinition(w);if(I){var V=I.getHitBoxes(i);if(V){t.lineStyle(n,l,o);try{for(var z=(d=void 0,r(V)),L=z.next();!L.done;L=z.next()){var j=L.value;if(0!==j.length){t.beginFill(a,s);for(var k=0;k<j.length;k++){var C=j[k][0],O=j[k][1];if(M&&(C=v-C),H&&(O=x-O),D){var X=C;C=O,O=X}0===k?t.moveTo(_+C,m+O):t.lineTo(_+C,m+O)}t.closePath(),t.endFill()}}}catch(t){d={error:t}}finally{try{L&&!L.done&&(c=z.return)&&c.call(z)}finally{if(d)throw d.error}}}}}}}catch(t){u={error:t}}finally{try{y&&!y.done&&(f=h.return)&&f.call(h)}finally{if(u)throw u.error}}}},t}(),F=function(){function t(){this._tileMapCache=new f,this._textureCacheCaches=new f}return t.getManager=function(e){return e.tileMapCollisionMaskManager||(e.tileMapCollisionMaskManager=new t),e.tileMapCollisionMaskManager},t.prototype.getOrLoadTileMap=function(t,e,i,r,n){var l=e+"|"+i;this._tileMapCache.getOrLoad(l,(function(n){t(e,i,(function(t){if(t){var e=h.load(r,t);n(e)}else n(null)}))}),n)},t.prototype.getOrLoadTextureCache=function(t,e,i,r,n,l){var o=r+"|"+n+"|"+i;this._textureCacheCaches.getOrLoad(o,(function(l){t(r,n,(function(t){if(t){var r=i?e(i):null,n=x.parseAtlas(t,r,e);l(n)}else l(null)}))}),l)},t}();t.EditableTileMap=n,t.EditableTileMapLayer=p,t.PixiTileMapHelper=x,t.TileDefinition=u,t.TileMapManager=F,t.TileTextureCache=g,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=TileMapHelper.js.map
