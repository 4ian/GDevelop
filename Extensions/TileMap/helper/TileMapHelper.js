!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.TileMapHelper=t():e.TileMapHelper=t()}("undefined"!=typeof self?self:this,(function(){return(()=>{"use strict";var e={359:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Polygon=void 0,t.Polygon=class{constructor(){}}},271:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PixiTileMapHelper=void 0;const l=i(470),s=i(595);var a=GlobalPIXIModule.PIXI;t.PixiTileMapHelper=class{static parseAtlas(e,t,i){if(!e.tiledversion)return console.warn("The loaded Tiled map does not contain a 'tiledversion' key. Are you sure this file has been exported from Tiled (mapeditor.org)?"),null;if(!e.tilesets.length||"source"in e.tilesets[0])return console.warn("The loaded Tiled map seems not to contain any tileset data (nothing in 'tilesets' key)."),null;const{tilewidth:l,tileheight:o,tilecount:r,tiles:n,image:d,columns:p,spacing:c,margin:h}=e.tilesets[0];t||(t=i(d));const g=r/p,u=l*p+c*(p-1)+2*h,f=o*g+c*(g-1)+2*h;if(1!==t.width&&u!==t.width||1!==t.height&&f!==t.height){const e=u+"x"+f,i=t.width+"x"+t.height;return console.warn("It seems the atlas file was resized, which is not supported. It should be "+e+"px, but it's "+i+" px."),null}const y=new s.TileTextureCache;for(let e=0;e<r;e++){const i=h+Math.floor(e%p)*(l+c),s=h+Math.floor(e/p)*(o+c);try{const r=new a.Rectangle(i,s,l,o),n=new a.Texture(t,r);y.setTexture(e,!1,!1,!1,n)}catch(e){console.error("An error occurred while creating a PIXI.Texture to be used in a TileMap:",e)}}return y}static updatePixiTileMap(e,t,i,s,a){if(e){e.clear();for(const o of t.getLayers()){if("index"===s&&a!==o.id)return;if(o instanceof l.EditableObjectLayer){const t=o;for(const l of t.objects){const s=i.findTileTexture(l.getTileId(),l.isFlippedHorizontally(),l.isFlippedVertically(),l.isFlippedDiagonally());s&&e.addFrame(s,l.x,l.y-t.tileMap.getTileHeight())}}else if(o instanceof l.EditableTileMapLayer){const t=o;for(let l=0;l<t.tileMap.getDimensionY();l++)for(let s=0;s<t.tileMap.getDimensionX();s++){const a=t.tileMap.getTileWidth()*s,o=t.tileMap.getTileHeight()*l,r=t.get(s,l),n=i.findTileTexture(r,t.isFlippedHorizontally(s,l),t.isFlippedVertically(s,l),t.isFlippedDiagonally(s,l));n&&(e.addFrame(n,a,o),t.tileMap.getTileDefinition(r))}}}}}static updatePixiCollisionMask(e,t,i,s,a,o,r,n,d,p){if(e){e.clear();for(const c of t.getLayers()){if("index"===i&&s!==c.id)return;const h=t.getTileWidth(),g=t.getTileHeight();if(c instanceof l.EditableTileMapLayer){const t=c;for(let i=0;i<t.tileMap.getDimensionY();i++)for(let l=0;l<t.tileMap.getDimensionX();l++){const s=h*l,c=g*i,u=t.get(l,i),f=t.isFlippedHorizontally(l,i),y=t.isFlippedVertically(l,i),T=t.isFlippedDiagonally(l,i),M=t.tileMap.getTileDefinition(u);if(M&&M.getTag()===a){e.lineStyle(o,r,n);for(const t of M.getPolygons()){const i=t.vertices;if(0!==i.length){e.beginFill(d,p);for(let t=0;t<i.length;t++){let l=i[t][0],a=i[t][1];if(f&&(l=h-l),y&&(a=g-a),T){const e=l;l=a,a=e}0===t?e.moveTo(s+l,c+a):e.lineTo(s+l,c+a)}e.closePath(),e.endFill()}}}}}}}}}},44:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ResourceCache=void 0,t.ResourceCache=class{constructor(){this._cachedValues=new Map,this._callbacks=new Map}getOrLoad(e,t,i){{const t=this._cachedValues.get(e);if(t)return void i(t)}{const t=this._callbacks.get(e);if(t)return void t.push(i);this._callbacks.set(e,[i])}t((t=>{t&&this._cachedValues.set(e,t);const i=this._callbacks.get(e);this._callbacks.delete(e);for(const e of i)e(t)}))}}},315:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TileMapManager=void 0;const l=i(271),s=i(44),a=i(47);class o{constructor(){this._tileMapCache=new s.ResourceCache,this._textureCacheCaches=new s.ResourceCache}static getManager(e){return e.tileMapCollisionMaskManager||(e.tileMapCollisionMaskManager=new o),e.tileMapCollisionMaskManager}getOrLoadTileMap(e,t,i,l,s){const o=t+"|"+i;this._tileMapCache.getOrLoad(o,(s=>{e(t,i,(e=>{if(!e)return void s(null);const t=a.TiledTileMapLoader.load(l,e);s(t)}))}),s)}getOrLoadTextureCache(e,t,i,s,a,o){const r=s+"|"+a+"|"+i;this._textureCacheCaches.getOrLoad(r,(o=>{e(s,a,(e=>{if(!e)return void o(null);const s=i?t(i):null,a=l.PixiTileMapHelper.parseAtlas(e,s,t);o(a)}))}),o)}}t.TileMapManager=o},470:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CollisionTileDefinition=t.EditableTileMapLayer=t.TileObject=t.EditableObjectLayer=t.EditableTileMap=void 0,t.EditableTileMap=class{constructor(e,t,i,l,s){console.log("tile dimension: "+e+" "+t),this.tileWidth=e,this.tileHeight=t,this.dimX=i,this.dimY=l,this._tileSet=s,this._layers=[]}getWidth(){return this.tileWidth*this.dimX}getHeight(){return this.tileHeight*this.dimY}getTileHeight(){return this.tileWidth}getTileWidth(){return this.tileHeight}getDimensionX(){return this.dimX}getDimensionY(){return this.dimY}getTileDefinition(e){return this._tileSet.get(e)}addTileLayer(e){const t=new l(this,e);return this._layers.push(t),t}addObjectLayer(e){const t=new i(this,e);return this._layers.push(t),t}getLayers(){return this._layers}pointIsInsideTile(e,t,i){const l=Math.floor(e/this.tileWidth),s=Math.floor(t/this.tileHeight);for(const e of this._layers){const t=e;if(!t)continue;const a=t.get(l,s);if(!a)return!1;if(this._tileSet.get(a).getTag()===i)return!0}return!1}};class i{constructor(e,t){this.tileMap=e,this.id=t,this.objects=[]}add(e){this.objects.push(e)}}t.EditableObjectLayer=i,t.TileObject=class{constructor(e,t,i){this.tileId=i,this.x=e,this.y=t}getTileId(){return this.tileId&l.tileIdMask}setFlippedHorizontally(e){let t=this.tileId;t&=~l.flippedHorizontallyFlag,e&&(t|=l.flippedHorizontallyFlag),this.tileId=t}setFlippedVertically(e){let t=this.tileId;t&=~l.flippedVerticallyFlag,e&&(t|=l.flippedVerticallyFlag),this.tileId=t}setFlippedDiagonally(e){let t=this.tileId;t&=~l.flippedDiagonallyFlag,e&&(t|=l.flippedDiagonallyFlag),this.tileId=t}isFlippedHorizontally(){return 0!=(this.tileId&l.flippedHorizontallyFlag)}isFlippedVertically(){return 0!=(this.tileId&l.flippedVerticallyFlag)}isFlippedDiagonally(){return 0!=(this.tileId&l.flippedDiagonallyFlag)}};class l{constructor(e,t){this.tileMap=e,this.id=t,this._tiles=[],this._tiles.length=this.tileMap.getDimensionY();for(let e=0;e<this._tiles.length;e++)this._tiles[e]=new Int32Array(this.tileMap.getDimensionX())}setTile(e,t,i){this.tileMap.getTileDefinition(i)&&(this._tiles[t][e]=i+1)}setFlippedHorizontally(e,t,i){let s=this._tiles[t][e];s&=~l.flippedHorizontallyFlag,i&&(s|=l.flippedHorizontallyFlag),this._tiles[t][e]=s}setFlippedVertically(e,t,i){let s=this._tiles[t][e];s&=~l.flippedVerticallyFlag,i&&(s|=l.flippedVerticallyFlag),this._tiles[t][e]=s}setFlippedDiagonally(e,t,i){let s=this._tiles[t][e];s&=~l.flippedDiagonallyFlag,i&&(s|=l.flippedDiagonallyFlag),this._tiles[t][e]=s}isFlippedHorizontally(e,t){return 0!=(this._tiles[t][e]&l.flippedHorizontallyFlag)}isFlippedVertically(e,t){return 0!=(this._tiles[t][e]&l.flippedVerticallyFlag)}isFlippedDiagonally(e,t){return 0!=(this._tiles[t][e]&l.flippedDiagonallyFlag)}get(e,t){const i=this._tiles[t];if(i&&0!==i[e])return i[e]-1&l.tileIdMask}dimX(){return 0===this._tiles.length?0:this._tiles[0].length}dimY(){return this._tiles.length}getWidth(){return this.tileMap.getWidth()}getHeight(){return this.tileMap.getHeight()}}t.EditableTileMapLayer=l,l.flippedHorizontallyFlag=2147483648,l.flippedVerticallyFlag=1073741824,l.flippedDiagonallyFlag=536870912,l.tileIdMask=~(l.flippedHorizontallyFlag|l.flippedVerticallyFlag|l.flippedDiagonallyFlag),t.CollisionTileDefinition=class{constructor(e,t=""){this.polygons=e,this.tag=t}getTag(){return this.tag}getPolygons(){return this.polygons}}},595:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TileTextureCache=void 0;var i=GlobalPIXIModule.PIXI;class l{constructor(){this._textures=new Map}setTexture(e,t,i,l,s){let a=this._getGlobalId(e,t,i,l);this._textures.set(a,s)}findTileTexture(e,t,l,s){let a=this._getGlobalId(e,t,l,s);if(0===a)return;if(this._textures.has(a))return this._textures.get(a);const o=this._textures.get(e);if(!o)return;const r=o.frame.clone(),n=o.orig.clone();if(s){const e=n.width;n.width=n.height,n.height=e}const d=n.clone();let p=0;s?(p=10,!t&&l?p=2:t&&!l?p=6:t&&l&&(p=14)):(p=0,!t&&l?p=8:t&&!l?p=12:t&&l&&(p=4));const c=new i.Texture(o.baseTexture,r,n,d,p);return this._textures.set(a,c),c}_getGlobalId(e,t,i,s){let a=e;return t&&(a|=l.flippedHorizontallyFlag),i&&(a|=l.flippedVerticallyFlag),s&&(a|=l.flippedDiagonallyFlag),a}}t.TileTextureCache=l,l.flippedHorizontallyFlag=2147483648,l.flippedVerticallyFlag=1073741824,l.flippedDiagonallyFlag=536870912},234:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.extractTileUidFlippedStates=t.decodeBase64LayerData=void 0,t.decodeBase64LayerData=(e,t)=>{const{data:i,compression:l}=t;if(!i)return i;let s=4;const a=[];let o=atob(i).split("").map((function(e){return e.charCodeAt(0)}));try{const t=(e,t)=>e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24)>>>0;if("zlib"===l){const i=new Uint8Array(o),l=e.inflate(i);for(;s<=l.length;)a.push(t(l,s-4)),s+=4}else{if("zstd"===l)return console.error("Zstandard compression is not supported for layers in a Tilemap. Use instead zlib compression or no compression."),null;for(;s<=o.length;)a.push(t(o,s-4)),s+=4}return a}catch(e){return console.error("Failed to decompress and unzip base64 layer.data string",e),null}},t.extractTileUidFlippedStates=e=>({id:536870911&e,flippedHorizontally:!!(2147483648&e),flippedVertically:!!(1073741824&e),flippedDiagonally:!!(536870912&e)})},47:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TiledTileMapLoader=void 0;const l=i(359),s=i(234),a=i(470);t.TiledTileMapLoader=class{static load(e,t){const i=new Map;for(const e of t.tilesets[0].tiles){const t=[];if(e.objectgroup)for(const i of e.objectgroup.objects){const e=new l.Polygon;i.polygon?e.vertices=i.polygon.map((e=>[e.x,e.y])):e.vertices=[[i.x,i.y],[i.x,i.y+i.height],[i.x+i.width,i.y+i.height],[i.x+i.width,i.y]],t.push(e)}i.set(e.id,new a.CollisionTileDefinition(t,e.type))}for(let e=0;e<t.tilesets[0].tilecount;e++)i.has(e)||i.set(e,new a.CollisionTileDefinition([],""));const o=new a.EditableTileMap(t.tilewidth,t.tileheight,t.width,t.height,i);for(const i of t.layers)if(i.visible)if("objectgroup"===i.type){const e=o.addObjectLayer(i.id);for(const t of i.objects){if(!t.visible)continue;const i=s.extractTileUidFlippedStates(t.gid),l=new a.TileObject(t.x,t.y,i.id);e.add(l),l.setFlippedHorizontally(i.flippedHorizontally),l.setFlippedVertically(i.flippedVertically),l.setFlippedDiagonally(i.flippedDiagonally)}}else if("tilelayer"===i.type){let t=0,l=null;if("base64"===i.encoding?(l=s.decodeBase64LayerData(e,i),l||console.warn("Failed to uncompress layer.data")):l=i.data,l){const e=o.addTileLayer(i.id);for(let a=0;a<i.height;a++)for(let o=0;o<i.width;o++){const i=l[t],r=s.extractTileUidFlippedStates(i);e.setTile(o,a,r.id-1),e.setFlippedHorizontally(o,a,r.flippedHorizontally),e.setFlippedVertically(o,a,r.flippedVertically),e.setFlippedDiagonally(o,a,r.flippedDiagonally),t+=1}}}return o}}},303:function(e,t,i){var l=this&&this.__createBinding||(Object.create?function(e,t,i,l){void 0===l&&(l=i),Object.defineProperty(e,l,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,l){void 0===l&&(l=i),e[l]=t[i]}),s=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||l(t,e,i)};Object.defineProperty(t,"__esModule",{value:!0}),t.PixiTileMapHelper=t.TileMapManager=void 0;const a=i(315);Object.defineProperty(t,"TileMapManager",{enumerable:!0,get:function(){return a.TileMapManager}});const o=i(271);Object.defineProperty(t,"PixiTileMapHelper",{enumerable:!0,get:function(){return o.PixiTileMapHelper}}),s(i(359),t),t.default=a.TileMapManager}},t={};return function i(l){var s=t[l];if(void 0!==s)return s.exports;var a=t[l]={exports:{}};return e[l].call(a.exports,a,a.exports,i),a.exports}(303)})()}));
//# sourceMappingURL=TileMapHelper.js.map