!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TileMapHelper={})}(this,(function(t){"use strict";var e=function(t,i){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},e(t,i)};function i(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}function r(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],r=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}var n=function(){function t(t,e,i,r,n){this.tileWidth=t,this.tileHeight=e,this.dimX=i,this.dimY=r,this._tileSet=n,this._layers=[]}return t.prototype.getWidth=function(){return this.tileWidth*this.dimX},t.prototype.getHeight=function(){return this.tileHeight*this.dimY},t.prototype.getTileHeight=function(){return this.tileWidth},t.prototype.getTileWidth=function(){return this.tileHeight},t.prototype.getDimensionX=function(){return this.dimX},t.prototype.getDimensionY=function(){return this.dimY},t.prototype.getTileDefinition=function(t){return this._tileSet.get(t)},t.prototype.getTileDefinitions=function(){return this._tileSet.values()},t.prototype.addTileLayer=function(t){var e=new p(this,t);return this._layers.push(e),e},t.prototype.addObjectLayer=function(t){var e=new o(this,t);return this._layers.push(e),e},t.prototype.getLayers=function(){return this._layers},t.prototype.pointIsInsideTile=function(t,e,i){var n,l,o=Math.floor(t/this.tileWidth),a=Math.floor(e/this.tileHeight);try{for(var s=r(this._layers),p=s.next();!p.done;p=s.next()){var d=p.value;if(d){var u=d.get(o,a);if(void 0===u)return!1;if(this._tileSet.get(u).hasTag(i))return!0}}}catch(t){n={error:t}}finally{try{p&&!p.done&&(l=s.return)&&l.call(s)}finally{if(n)throw n.error}}return!1},t}(),l=function(){function t(t,e){this.visible=!0,this.tileMap=t,this.id=e}return t.prototype.setVisible=function(t){this.visible=t},t.prototype.isVisible=function(){return this.visible},t}(),o=function(t){function e(e,i){var r=t.call(this,e,i)||this;return r.objects=[],r}return i(e,t),e.prototype.add=function(t){this.objects.push(t)},e}(l),a=function(){function t(t,e,i){this.tileId=i,this.x=t,this.y=e}return t.prototype.getTileId=function(){return s.getTileId(this.tileId)},t.prototype.setFlippedHorizontally=function(t){this.tileId=s.setFlippedHorizontally(this.tileId,t)},t.prototype.setFlippedVertically=function(t){this.tileId=s.setFlippedVertically(this.tileId,t)},t.prototype.setFlippedDiagonally=function(t){this.tileId=s.setFlippedDiagonally(this.tileId,t)},t.prototype.isFlippedHorizontally=function(){return s.isFlippedHorizontally(this.tileId)},t.prototype.isFlippedVertically=function(){return s.isFlippedVertically(this.tileId)},t.prototype.isFlippedDiagonally=function(){return s.isFlippedDiagonally(this.tileId)},t}(),s=function(){function t(){}return t.getTileId=function(e){return e&t.tileIdMask},t.setFlippedHorizontally=function(e,i){return e&=~t.flippedHorizontallyFlag,i&&(e|=t.flippedHorizontallyFlag),e},t.setFlippedVertically=function(e,i){return e&=~t.flippedVerticallyFlag,i&&(e|=t.flippedVerticallyFlag),e},t.setFlippedDiagonally=function(e,i){return e&=~t.flippedDiagonallyFlag,i&&(e|=t.flippedDiagonallyFlag),e},t.isFlippedHorizontally=function(e){return 0!=(e&t.flippedHorizontallyFlag)},t.isFlippedVertically=function(e){return 0!=(e&t.flippedVerticallyFlag)},t.isFlippedDiagonally=function(e){return 0!=(e&t.flippedDiagonallyFlag)},t.flippedHorizontallyFlag=2147483648,t.flippedVerticallyFlag=1073741824,t.flippedDiagonallyFlag=536870912,t.tileIdMask=~(t.flippedHorizontallyFlag|t.flippedVerticallyFlag|t.flippedDiagonallyFlag),t}(),p=function(t){function e(e,i){var r=t.call(this,e,i)||this;r._tiles=[],r._tiles.length=r.tileMap.getDimensionY();for(var n=0;n<r._tiles.length;n++)r._tiles[n]=new Int32Array(r.tileMap.getDimensionX());return r}return i(e,t),e.prototype.setTile=function(t,e,i){this.tileMap.getTileDefinition(i)?this._tiles[e][t]=i+1:console.error("Invalid tile definition index: ".concat(i))},e.prototype.removeTile=function(t,e){this._tiles[e][t]=0},e.prototype.setFlippedHorizontally=function(t,e,i){var r=this._tiles[e][t];0!==r&&(this._tiles[e][t]=s.setFlippedHorizontally(r,i))},e.prototype.setFlippedVertically=function(t,e,i){var r=this._tiles[e][t];0!==r&&(this._tiles[e][t]=s.setFlippedVertically(r,i))},e.prototype.setFlippedDiagonally=function(t,e,i){var r=this._tiles[e][t];0!==r&&(this._tiles[e][t]=s.setFlippedDiagonally(r,i))},e.prototype.isFlippedHorizontally=function(t,e){return s.isFlippedHorizontally(this._tiles[e][t])},e.prototype.isFlippedVertically=function(t,e){return s.isFlippedVertically(this._tiles[e][t])},e.prototype.isFlippedDiagonally=function(t,e){return s.isFlippedDiagonally(this._tiles[e][t])},e.prototype.get=function(t,e){var i=this._tiles[e];if(i&&0!==i[t])return s.getTileId(i[t]-1)},e.prototype.getDimensionX=function(){return 0===this._tiles.length?0:this._tiles[0].length},e.prototype.getDimensionY=function(){return this._tiles.length},e.prototype.getWidth=function(){return this.tileMap.getWidth()},e.prototype.getHeight=function(){return this.tileMap.getHeight()},e}(l),d=function(){function t(t){this.taggedHitBoxes=[],this.animationLength=t}return t.prototype.add=function(t,e){var i=this.taggedHitBoxes.find((function(e){return e.tag===t}));i||(i={tag:t,polygons:[]},this.taggedHitBoxes.push(i)),i.polygons.push(e)},t.prototype.hasTag=function(t){return this.taggedHitBoxes.some((function(e){return e.tag===t}))},t.prototype.getHitBoxes=function(t){var e=this.taggedHitBoxes.find((function(e){return e.tag===t}));return e&&e.polygons},t.prototype.getAnimationLength=function(){return this.animationLength},t}(),u=function(){function t(){this._cachedValues=new Map,this._callbacks=new Map}return t.prototype.getOrLoad=function(t,e,i){var n=this,l=this._cachedValues.get(t);if(l)i(l);else{var o=this._callbacks.get(t);o?o.push(i):(this._callbacks.set(t,[i]),e((function(e){var i,l;e&&n._cachedValues.set(t,e);var o=n._callbacks.get(t);n._callbacks.delete(t);try{for(var a=r(o),s=a.next();!s.done;s=a.next()){(0,s.value)(e)}}catch(t){i={error:t}}finally{try{s&&!s.done&&(l=a.return)&&l.call(a)}finally{if(i)throw i.error}}})))}},t}(),f=function(t,e){var i=e.data,r=e.compression;if(!i)return i;var n=4,l=[],o=atob(i).split("").map((function(t){return t.charCodeAt(0)}));try{var a=function(t,e){return t[e]+(t[e+1]<<8)+(t[e+2]<<16)+(t[e+3]<<24)>>>0};if("zlib"===r)for(var s=new Uint8Array(o),p=t.inflate(s);n<=p.length;)l.push(a(p,n-4)),n+=4;else{if("zstd"===r)return console.error("Zstandard compression is not supported for layers in a Tilemap. Use instead zlib compression or no compression."),null;for(;n<=o.length;)l.push(a(o,n-4)),n+=4}return l}catch(t){return console.error("Failed to decompress and unzip base64 layer.data string",t),null}},c=function(t){var e=2147483648,i=1073741824,r=536870912,n=t&e,l=t&i,o=t&r;return{id:h(536870911&t),flippedHorizontally:!!n,flippedVertically:!!l,flippedDiagonally:!!o}},h=function(t){return 0===t?void 0:t-1},y=function(){function t(){}return t.load=function(t,e){var i,l,o,s,p,u,y,g,v,x;if(!e.tiledversion)return console.warn("The loaded Tiled map does not contain a 'tiledversion' key. Are you sure this file has been exported from Tiled (mapeditor.org)?"),null;var F=new Map;try{for(var T=r(e.tilesets),b=T.next();!b.done;b=T.next()){var w=b.value,_=void 0===w.firstgid?1:w.firstgid;if(w.tiles)try{for(var m=(o=void 0,r(w.tiles)),M=m.next();!M.done;M=m.next()){var H=M.value,D=new d(H.animation?H.animation.length:0);if(H.objectgroup){var I=function(t){var e=t.class||H.class;if(!e||0===e.length)return"continue";var i=null;if(t.polygon){var r=t.rotation*Math.PI/180,n=Math.cos(r),l=Math.sin(r);-1!==n&&1!==n||(l=0),-1!==l&&1!==l||(n=0),i=t.polygon.map((function(e){return[t.x+e.x*n-e.y*l,t.y+e.x*l+e.y*n]}))}else void 0!==t.x&&void 0!==t.y&&void 0!==t.width&&void 0!==t.height&&(i=[[t.x,t.y],[t.x,t.y+t.height],[t.x+t.width,t.y+t.height],[t.x+t.width,t.y]]);i&&D.add(e,i)};try{for(var V=(p=void 0,r(H.objectgroup.objects)),z=V.next();!z.done;z=V.next()){I(G=z.value)}}catch(t){p={error:t}}finally{try{z&&!z.done&&(u=V.return)&&u.call(V)}finally{if(p)throw p.error}}}else if(H.class&&H.class.length>0){var L=[[0,0],[0,e.tileheight],[e.tilewidth,e.tileheight],[e.tilewidth,0]];D.add(H.class,L)}F.set(h(_+H.id),D)}}catch(t){o={error:t}}finally{try{M&&!M.done&&(s=m.return)&&s.call(m)}finally{if(o)throw o.error}}for(var j=0;j<w.tilecount;j++){var k=h(_+j);F.has(k)||F.set(k,new d(0))}}}catch(t){i={error:t}}finally{try{b&&!b.done&&(l=T.return)&&l.call(T)}finally{if(i)throw i.error}}var C=new n(e.tilewidth,e.tileheight,e.width,e.height,F);try{for(var O=r(e.layers),X=O.next();!X.done;X=O.next()){var A=X.value;if("objectgroup"===A.type){var P=C.addObjectLayer(A.id);P.setVisible(A.visible);try{for(var W=(v=void 0,r(A.objects)),S=W.next();!S.done;S=W.next()){var Y=S.value;if(Y.visible&&Y.gid){var B=c(Y.gid),G=new a(Y.x,Y.y,B.id);P.add(G),G.setFlippedHorizontally(B.flippedHorizontally),G.setFlippedVertically(B.flippedVertically),G.setFlippedDiagonally(B.flippedDiagonally)}}}catch(t){v={error:t}}finally{try{S&&!S.done&&(x=W.return)&&x.call(W)}finally{if(v)throw v.error}}}else if("tilelayer"===A.type){var E=0,R=null;if("base64"===A.encoding?(R=f(t,A))||console.warn("Failed to uncompress layer.data"):R=A.data,R){var U=C.addTileLayer(A.id);U.setVisible(A.visible);for(var Z=0;Z<A.height;Z++)for(var q=0;q<A.width;q++){var J=R[E],K=c(J);void 0!==K.id&&(U.setTile(q,Z,K.id),U.setFlippedHorizontally(q,Z,K.flippedHorizontally),U.setFlippedVertically(q,Z,K.flippedVertically),U.setFlippedDiagonally(q,Z,K.flippedDiagonally)),E+=1}}}}}catch(t){y={error:t}}finally{try{X&&!X.done&&(g=O.return)&&g.call(O)}finally{if(y)throw y.error}}return C},t}(),g=GlobalPIXIModule.PIXI,v=function(){function t(){this._textures=new Map}return t.prototype.setTexture=function(t,e,i,r,n){var l=this._getGlobalId(t,e,i,r);this._textures.set(l,n)},t.prototype.findTileTexture=function(t,e,i,r){var n=this._getGlobalId(t,e,i,r);if(this._textures.has(n))return this._textures.get(n);var l=this._textures.get(t);if(l){var o=l.frame.clone(),a=l.orig.clone();if(r){var s=a.width;a.width=a.height,a.height=s}var p=a.clone(),d=0;r?(d=10,!e&&i?d=2:e&&!i?d=6:e&&i&&(d=14)):(d=0,!e&&i?d=8:e&&!i?d=12:e&&i&&(d=4));var u=new g.Texture(l.baseTexture,o,a,p,d);return this._textures.set(n,u),u}},t.prototype._getGlobalId=function(e,i,r,n){var l=e;return i&&(l|=t.flippedHorizontallyFlag),r&&(l|=t.flippedVerticallyFlag),n&&(l|=t.flippedDiagonallyFlag),l},t.flippedHorizontallyFlag=2147483648,t.flippedVerticallyFlag=1073741824,t.flippedDiagonallyFlag=536870912,t}(),x=GlobalPIXIModule.PIXI,F=function(){function t(){}return t.parseAtlas=function(t,e,i){if(!t.tiledversion)return console.warn("The loaded Tiled map does not contain a 'tiledversion' key. Are you sure this file has been exported from Tiled (mapeditor.org)?"),null;if(!t.tilesets.length||"source"in t.tilesets[0])return console.warn("The loaded Tiled map seems not to contain any tileset data (nothing in 'tilesets' key)."),null;var r=t.tilesets[0],n=r.tilewidth,l=r.tileheight,o=r.tilecount,a=r.image,s=r.columns,p=r.spacing,d=r.margin,u=void 0===r.firstgid?1:r.firstgid;e||(e=i(a));var f=o/s,c=n*s+p*(s-1)+2*d,y=l*f+p*(f-1)+2*d;if(1!==e.width&&c!==e.width||1!==e.height&&y!==e.height){var g=c+"x"+y,F=e.width+"x"+e.height;return console.warn("It seems the atlas file was resized, which is not supported. It should be "+g+"px, but it's "+F+" px."),null}for(var T=new v,b=0;b<o;b++){var w=d+Math.floor(b%s)*(n+p),_=d+Math.floor(b/s)*(l+p),m=h(u+b);try{var M=new x.Rectangle(w,_,n,l),H=new x.Texture(e,M);T.setTexture(m,!1,!1,!1,H)}catch(t){console.error("An error occurred while creating a PIXI.Texture to be used in a TileMap:",t)}}return T},t.updatePixiTileMap=function(t,e,i,n,l){var a,s,d,u,f=t;if(f){f.clear();try{for(var c=r(e.getLayers()),h=c.next();!h.done;h=c.next()){var y=h.value;if("index"===n&&l!==y.id||"visible"===n&&!y.isVisible())return;if(y instanceof o){var g=y;try{for(var v=(d=void 0,r(g.objects)),x=v.next();!x.done;x=v.next()){var F=x.value,T=i.findTileTexture(F.getTileId(),F.isFlippedHorizontally(),F.isFlippedVertically(),F.isFlippedDiagonally());T&&f.addFrame(T,F.x,F.y-g.tileMap.getTileHeight())}}catch(t){d={error:t}}finally{try{x&&!x.done&&(u=v.return)&&u.call(v)}finally{if(d)throw d.error}}}else if(y instanceof p)for(var b=y,w=0;w<b.tileMap.getDimensionY();w++)for(var _=0;_<b.tileMap.getDimensionX();_++){var m=b.tileMap.getTileWidth(),M=m*_,H=b.tileMap.getTileHeight()*w,D=b.get(_,w);if(void 0!==D){var I=i.findTileTexture(D,b.isFlippedHorizontally(_,w),b.isFlippedVertically(_,w),b.isFlippedDiagonally(_,w));if(I){var V=f.addFrame(I,M,H),z=b.tileMap.getTileDefinition(D);z&&z.getAnimationLength()>0&&V.tileAnimX(m,z.getAnimationLength())}}}}}catch(t){a={error:t}}finally{try{h&&!h.done&&(s=c.return)&&s.call(c)}finally{if(a)throw a.error}}}},t.updatePixiCollisionMask=function(t,e,i,n,l,o,a,s){var d,u,f,c;if(t){t.clear(),t.lineStyle(n,l,o),t.drawRect(0,0,e.getWidth(),e.getHeight());try{for(var h=r(e.getLayers()),y=h.next();!y.done;y=h.next()){var g=y.value,v=e.getTileWidth(),x=e.getTileHeight();if(g instanceof p)for(var F=g,T=0;T<F.tileMap.getDimensionY();T++)for(var b=0;b<F.tileMap.getDimensionX();b++){var w=v*b,_=x*T,m=F.get(b,T),M=F.isFlippedHorizontally(b,T),H=F.isFlippedVertically(b,T),D=F.isFlippedDiagonally(b,T),I=F.tileMap.getTileDefinition(m);if(I){var V=I.getHitBoxes(i);if(V)try{for(var z=(f=void 0,r(V)),L=z.next();!L.done;L=z.next()){var j=L.value;if(0!==j.length){t.beginFill(a,s);for(var k=0;k<j.length;k++){var C=j[k][0],O=j[k][1];if(M&&(C=v-C),H&&(O=x-O),D){var X=C;C=O,O=X}0===k?t.moveTo(w+C,_+O):t.lineTo(w+C,_+O)}t.closePath(),t.endFill()}}}catch(t){f={error:t}}finally{try{L&&!L.done&&(c=z.return)&&c.call(z)}finally{if(f)throw f.error}}}}}}catch(t){d={error:t}}finally{try{y&&!y.done&&(u=h.return)&&u.call(h)}finally{if(d)throw d.error}}}},t}(),T=function(){function t(){this._tileMapCache=new u,this._textureCacheCaches=new u}return t.getManager=function(e){return e.tileMapCollisionMaskManager||(e.tileMapCollisionMaskManager=new t),e.tileMapCollisionMaskManager},t.prototype.getOrLoadTileMap=function(t,e,i,r,n){var l=e+"|"+i;this._tileMapCache.getOrLoad(l,(function(n){t(e,i,(function(t){if(t){var e=y.load(r,t);n(e)}else n(null)}))}),n)},t.prototype.getOrLoadTextureCache=function(t,e,i,r,n,l){var o=r+"|"+n+"|"+i;this._textureCacheCaches.getOrLoad(o,(function(l){t(r,n,(function(t){if(t){var r=i?e(i):null,n=F.parseAtlas(t,r,e);l(n)}else l(null)}))}),l)},t}();t.EditableTileMap=n,t.EditableTileMapLayer=p,t.PixiTileMapHelper=F,t.TileDefinition=d,t.TileMapManager=T,t.TileTextureCache=v,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=TileMapHelper.js.map
