!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TileMapHelper={})}(this,(function(t){"use strict";var e=function(t,i){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},e(t,i)};function i(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}function n(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],n=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}var l,r,o,a,s,p,d=function(){function t(t,e,i,n,l){this.tileWidth=t,this.tileHeight=e,this.dimX=i,this.dimY=n,this._tileSet=l,this._layers=[]}return t.prototype.getWidth=function(){return this.tileWidth*this.dimX},t.prototype.getHeight=function(){return this.tileHeight*this.dimY},t.prototype.getTileHeight=function(){return this.tileHeight},t.prototype.getTileWidth=function(){return this.tileWidth},t.prototype.getDimensionX=function(){return this.dimX},t.prototype.getDimensionY=function(){return this.dimY},t.prototype.getTileDefinition=function(t){return this._tileSet.get(t)},t.prototype.getTileDefinitions=function(){return this._tileSet.values()},t.prototype.addTileLayer=function(t){var e=new y(this,t);return this._layers.push(e),e},t.prototype.addObjectLayer=function(t){var e=new u(this,t);return this._layers.push(e),e},t.prototype.getLayers=function(){return this._layers},t.prototype.pointIsInsideTile=function(t,e,i){var l,r,o=Math.floor(t/this.tileWidth),a=Math.floor(e/this.tileHeight);try{for(var s=n(this._layers),p=s.next();!p.done;p=s.next()){var d=p.value;if(d){var c=d.get(o,a);if(void 0===c)return!1;if(this._tileSet.get(c).hasTag(i))return!0}}}catch(t){l={error:t}}finally{try{p&&!p.done&&(r=s.return)&&r.call(s)}finally{if(l)throw l.error}}return!1},t}(),c=function(){function t(t,e){this.visible=!0,this.tileMap=t,this.id=e}return t.prototype.setVisible=function(t){this.visible=t},t.prototype.isVisible=function(){return this.visible},t}(),u=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.objects=[],n}return i(e,t),e.prototype.add=function(t){this.objects.push(t)},e}(c),f=function(){function t(t,e,i){this.tileId=i,this.x=t,this.y=e}return t.prototype.getTileId=function(){return h.getTileId(this.tileId)},t.prototype.setFlippedHorizontally=function(t){this.tileId=h.setFlippedHorizontally(this.tileId,t)},t.prototype.setFlippedVertically=function(t){this.tileId=h.setFlippedVertically(this.tileId,t)},t.prototype.setFlippedDiagonally=function(t){this.tileId=h.setFlippedDiagonally(this.tileId,t)},t.prototype.isFlippedHorizontally=function(){return h.isFlippedHorizontally(this.tileId)},t.prototype.isFlippedVertically=function(){return h.isFlippedVertically(this.tileId)},t.prototype.isFlippedDiagonally=function(){return h.isFlippedDiagonally(this.tileId)},t}(),h=function(){function t(){}return t.getTileId=function(e){return e&t.tileIdMask},t.setFlippedHorizontally=function(e,i){return e&=~t.flippedHorizontallyFlag,i&&(e|=t.flippedHorizontallyFlag),e},t.setFlippedVertically=function(e,i){return e&=~t.flippedVerticallyFlag,i&&(e|=t.flippedVerticallyFlag),e},t.setFlippedDiagonally=function(e,i){return e&=~t.flippedDiagonallyFlag,i&&(e|=t.flippedDiagonallyFlag),e},t.isFlippedHorizontally=function(e){return 0!=(e&t.flippedHorizontallyFlag)},t.isFlippedVertically=function(e){return 0!=(e&t.flippedVerticallyFlag)},t.isFlippedDiagonally=function(e){return 0!=(e&t.flippedDiagonallyFlag)},t.flippedHorizontallyFlag=2147483648,t.flippedVerticallyFlag=1073741824,t.flippedDiagonallyFlag=536870912,t.tileIdMask=~(t.flippedHorizontallyFlag|t.flippedVerticallyFlag|t.flippedDiagonallyFlag),t}(),y=function(t){function e(e,i){var n=t.call(this,e,i)||this;n._tiles=[],n._tiles.length=n.tileMap.getDimensionY();for(var l=0;l<n._tiles.length;l++)n._tiles[l]=new Int32Array(n.tileMap.getDimensionX());return n}return i(e,t),e.prototype.setTile=function(t,e,i){this.tileMap.getTileDefinition(i)?this._tiles[e][t]=i+1:console.error("Invalid tile definition index: ".concat(i))},e.prototype.removeTile=function(t,e){this._tiles[e][t]=0},e.prototype.setFlippedHorizontally=function(t,e,i){var n=this._tiles[e][t];0!==n&&(this._tiles[e][t]=h.setFlippedHorizontally(n,i))},e.prototype.setFlippedVertically=function(t,e,i){var n=this._tiles[e][t];0!==n&&(this._tiles[e][t]=h.setFlippedVertically(n,i))},e.prototype.setFlippedDiagonally=function(t,e,i){var n=this._tiles[e][t];0!==n&&(this._tiles[e][t]=h.setFlippedDiagonally(n,i))},e.prototype.isFlippedHorizontally=function(t,e){return h.isFlippedHorizontally(this._tiles[e][t])},e.prototype.isFlippedVertically=function(t,e){return h.isFlippedVertically(this._tiles[e][t])},e.prototype.isFlippedDiagonally=function(t,e){return h.isFlippedDiagonally(this._tiles[e][t])},e.prototype.get=function(t,e){var i=this._tiles[e];if(i&&0!==i[t])return h.getTileId(i[t]-1)},e.prototype.getDimensionX=function(){return 0===this._tiles.length?0:this._tiles[0].length},e.prototype.getDimensionY=function(){return this._tiles.length},e.prototype.getWidth=function(){return this.tileMap.getWidth()},e.prototype.getHeight=function(){return this.tileMap.getHeight()},e}(c),g=function(){function t(t){this.taggedHitBoxes=[],this.animationLength=t}return t.prototype.add=function(t,e){var i=this.taggedHitBoxes.find((function(e){return e.tag===t}));i||(i={tag:t,polygons:[]},this.taggedHitBoxes.push(i)),i.polygons.push(e)},t.prototype.hasTag=function(t){return this.taggedHitBoxes.some((function(e){return e.tag===t}))},t.prototype.getHitBoxes=function(t){var e=this.taggedHitBoxes.find((function(e){return e.tag===t}));return e&&e.polygons},t.prototype.getAnimationLength=function(){return this.animationLength},t}(),v=function(){function t(){this._cachedValues=new Map,this._callbacks=new Map}return t.prototype.getOrLoad=function(t,e,i){var l=this,r=this._cachedValues.get(t);if(r)i(r);else{var o=this._callbacks.get(t);o?o.push(i):(this._callbacks.set(t,[i]),e((function(e){var i,r;e&&l._cachedValues.set(t,e);var o=l._callbacks.get(t);l._callbacks.delete(t);try{for(var a=n(o),s=a.next();!s.done;s=a.next()){(0,s.value)(e)}}catch(t){i={error:t}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(i)throw i.error}}})))}},t}(),x=function(){function t(){this._textures=new Map}return t.prototype.setTexture=function(t,e,i,n,l){var r=this._getGlobalId(t,e,i,n);this._textures.set(r,l)},t.prototype.findTileTexture=function(t){return this._textures.get(t)},t.prototype.getPixiRotate=function(t,e,i){var n=0;return i?(n=10,!t&&e?n=2:t&&!e?n=6:t&&e&&(n=14)):(n=0,!t&&e?n=8:t&&!e?n=12:t&&e&&(n=4)),n},t.prototype._getGlobalId=function(e,i,n,l){var r=e;return i&&(r|=t.flippedHorizontallyFlag),n&&(r|=t.flippedVerticallyFlag),l&&(r|=t.flippedDiagonallyFlag),r},t.flippedHorizontallyFlag=2147483648,t.flippedVerticallyFlag=1073741824,t.flippedDiagonallyFlag=536870912,t}(),T=function(t,e){var i=e.data,n=e.compression;if(!i)return i;var l=4,r=[],o=atob(i).split("").map((function(t){return t.charCodeAt(0)}));try{var a=function(t,e){return t[e]+(t[e+1]<<8)+(t[e+2]<<16)+(t[e+3]<<24)>>>0};if("zlib"===n)for(var s=new Uint8Array(o),p=t.inflate(s);l<=p.length;)r.push(a(p,l-4)),l+=4;else{if("zstd"===n)return console.error("Zstandard compression is not supported for layers in a Tilemap. Use instead zlib compression or no compression."),null;for(;l<=o.length;)r.push(a(o,l-4)),l+=4}return r}catch(t){return console.error("Failed to decompress and unzip base64 layer.data string",t),null}},_=function(t){var e=2147483648,i=1073741824,n=536870912,l=t&e,r=t&i,o=t&n;return{id:F(536870911&t),flippedHorizontally:!!l,flippedVertically:!!r,flippedDiagonally:!!o}},F=function(t){return 0===t?void 0:t-1},w=GlobalPIXIModule.PIXI;!function(t){t.parseAtlas=function(t,e,i){if(!t.tiledversion)return console.warn("The loaded Tiled map does not contain a 'tiledversion' key. Are you sure this file has been exported from Tiled (mapeditor.org)?"),null;if(!t.tilesets.length||"source"in t.tilesets[0])return console.warn("The loaded Tiled map seems not to contain any tileset data (nothing in 'tilesets' key)."),null;var n=t.tilesets[0],l=n.tilewidth,r=n.tileheight,o=n.tilecount,a=n.image,s=n.columns,p=n.spacing,d=n.margin,c=void 0===n.firstgid?1:n.firstgid;e||(e=i(a));var u=o/s,f=l*s+p*(s-1)+2*d,h=r*u+p*(u-1)+2*d;if(1!==e.width&&e.width<f||e.width>=f+p+l||1!==e.height&&e.height<h||e.height>=h+p+r)return console.error("It seems the atlas file was resized, which is not supported. "+"It should be ".concat(f,"x").concat(h," px, ")+"but it's ".concat(e.width,"x").concat(e.height," px.")),null;if(1!==e.width&&e.width!==f||1!==e.height&&e.height!==h)return console.warn("It seems the atlas file has unused pixels. "+"It should be ".concat(f,"x").concat(h," px, ")+"but it's ".concat(e.width,"x").concat(e.height," px.")),null;for(var y=new x,g=0;g<o;g++){var v=d+Math.floor(g%s)*(l+p),T=d+Math.floor(g/s)*(r+p),_=F(c+g);try{var m=new w.Rectangle(v,T,l,r),b=new w.Texture(e,m);y.setTexture(_,!1,!1,!1,b)}catch(t){console.error("An error occurred while creating a PIXI.Texture to be used in a TileMap:",t)}}return y}}(l||(l={})),function(t){t.parseAtlas=function(t,e,i){return null}}(r||(r={})),t.PixiTileMapHelper=void 0,(o=t.PixiTileMapHelper||(t.PixiTileMapHelper={})).parseAtlas=function(t,e,i){return"ldtk"===t.kind?r.parseAtlas(t.data,e,i):"tiled"===t.kind?l.parseAtlas(t.data,e,i):(console.warn("The loaded Tiled map data does not contain a 'tiledversion' or '__header__' key. Are you sure this file has been exported from Tiled (mapeditor.org) or LDtk (ldtk.io)?"),null)},o.updatePixiTileMap=function(t,e,i,l,r,o){var a,s,p,d;console.log(e),console.log(r,o);var c=t;if(c){c.clear();try{for(var f=n(e.getLayers()),h=f.next();!h.done;h=f.next()){var g=h.value;if(!("index"===l&&r!==g.id||"visible"===l&&!g.isVisible()))if(g instanceof u){var v=g;try{for(var x=(p=void 0,n(v.objects)),T=x.next();!T.done;T=x.next()){var _=T.value,F=i.findTileTexture(_.getTileId());if(F){var w=i.getPixiRotate(_.isFlippedHorizontally(),_.isFlippedVertically(),_.isFlippedDiagonally());c.tile(F,_.x,_.y-v.tileMap.getTileHeight(),{rotate:w})}}}catch(t){p={error:t}}finally{try{T&&!T.done&&(d=x.return)&&d.call(x)}finally{if(p)throw p.error}}}else if(g instanceof y)for(var m=g,b=m.tileMap.getTileWidth(),M=m.tileMap.getTileHeight(),H=m.tileMap.getDimensionX(),D=m.tileMap.getDimensionY(),k=0;k<D;k++)for(var I=0;I<H;I++){var V=b*I,z=M*k,L=m.get(I,k);if(void 0!==L){var A=i.findTileTexture(L);if(A){w=i.getPixiRotate(m.isFlippedHorizontally(I,k),m.isFlippedVertically(I,k),m.isFlippedDiagonally(I,k));var j=c.tile(A,V,z,{rotate:w}),P=m.tileMap.getTileDefinition(L);P&&P.getAnimationLength()>0&&j.tileAnimX(b,P.getAnimationLength())}else console.warn("Unknown tile id: ".concat(L," at (").concat(I,", ").concat(k,")"))}}}}catch(t){a={error:t}}finally{try{h&&!h.done&&(s=f.return)&&s.call(f)}finally{if(a)throw a.error}}}},o.updatePixiCollisionMask=function(t,e,i,l,r,o,a,s){var p,d,c,u;if(t){t.clear(),t.lineStyle(l,r,o),t.drawRect(0,0,e.getWidth(),e.getHeight());try{for(var f=n(e.getLayers()),h=f.next();!h.done;h=f.next()){var g=h.value,v=e.getTileWidth(),x=e.getTileHeight();if(g instanceof y)for(var T=g,_=0;_<T.tileMap.getDimensionY();_++)for(var F=0;F<T.tileMap.getDimensionX();F++){var w=v*F,m=x*_,b=T.get(F,_),M=T.isFlippedHorizontally(F,_),H=T.isFlippedVertically(F,_),D=T.isFlippedDiagonally(F,_),k=T.tileMap.getTileDefinition(b);if(k){var I=k.getHitBoxes(i);if(I)try{for(var V=(c=void 0,n(I)),z=V.next();!z.done;z=V.next()){var L=z.value;if(0!==L.length){t.beginFill(a,s);for(var A=0;A<L.length;A++){var j=L[A][0],P=L[A][1];if(D){var C=j;j=P,P=C}M&&(j=v-j),H&&(P=x-P),0===A?t.moveTo(w+j,m+P):t.lineTo(w+j,m+P)}t.closePath(),t.endFill()}}}catch(t){c={error:t}}finally{try{z&&!z.done&&(u=V.return)&&u.call(V)}finally{if(c)throw c.error}}}}}}catch(t){p={error:t}}finally{try{h&&!h.done&&(d=f.return)&&d.call(f)}finally{if(p)throw p.error}}}},function(t){t.load=function(t,e){var i,l,r,o,a,s,p,c,u,h;if(!e.tiledversion)return console.warn("The loaded Tiled map does not contain a 'tiledversion' key. Are you sure this file has been exported from Tiled (mapeditor.org)?"),null;var y=new Map;try{for(var v=n(e.tilesets),x=v.next();!x.done;x=v.next()){var w=x.value,m=void 0===w.firstgid?1:w.firstgid;if(w.tiles)try{for(var b=(r=void 0,n(w.tiles)),M=b.next();!M.done;M=b.next()){var H=M.value,D=new g(H.animation?H.animation.length:0);if(H.objectgroup){var k=function(t){var e=t.class||H.class;if(!e||0===e.length)return"continue";var i=null;if(t.polygon){var n=t.rotation*Math.PI/180,l=Math.cos(n),r=Math.sin(n);-1!==l&&1!==l||(r=0),-1!==r&&1!==r||(l=0),i=t.polygon.map((function(e){return[t.x+e.x*l-e.y*r,t.y+e.x*r+e.y*l]}))}else void 0!==t.x&&void 0!==t.y&&void 0!==t.width&&void 0!==t.height&&(i=[[t.x,t.y],[t.x,t.y+t.height],[t.x+t.width,t.y+t.height],[t.x+t.width,t.y]]);i&&D.add(e,i)};try{for(var I=(a=void 0,n(H.objectgroup.objects)),V=I.next();!V.done;V=I.next()){k(R=V.value)}}catch(t){a={error:t}}finally{try{V&&!V.done&&(s=I.return)&&s.call(I)}finally{if(a)throw a.error}}}else if(H.class&&H.class.length>0){var z=[[0,0],[0,e.tileheight],[e.tilewidth,e.tileheight],[e.tilewidth,0]];D.add(H.class,z)}y.set(F(m+H.id),D)}}catch(t){r={error:t}}finally{try{M&&!M.done&&(o=b.return)&&o.call(b)}finally{if(r)throw r.error}}for(var L=0;L<w.tilecount;L++){var A=F(m+L);y.has(A)||y.set(A,new g(0))}}}catch(t){i={error:t}}finally{try{x&&!x.done&&(l=v.return)&&l.call(v)}finally{if(i)throw i.error}}var j=new d(e.tilewidth,e.tileheight,e.width,e.height,y);try{for(var P=n(e.layers),C=P.next();!C.done;C=P.next()){var O=C.value;if("objectgroup"===O.type){var X=j.addObjectLayer(O.id);X.setVisible(O.visible);try{for(var W=(u=void 0,n(O.objects)),S=W.next();!S.done;S=W.next()){var Y=S.value;if(Y.visible&&Y.gid){var B=_(Y.gid),R=new f(Y.x,Y.y,B.id);X.add(R),R.setFlippedHorizontally(B.flippedHorizontally),R.setFlippedVertically(B.flippedVertically),R.setFlippedDiagonally(B.flippedDiagonally)}}}catch(t){u={error:t}}finally{try{S&&!S.done&&(h=W.return)&&h.call(W)}finally{if(u)throw u.error}}}else if("tilelayer"===O.type){var E=0,G=null;if("base64"===O.encoding?(G=T(t,O))||console.warn("Failed to uncompress layer.data"):G=O.data,G){var U=j.addTileLayer(O.id);U.setVisible(O.visible);for(var Z=0;Z<O.height;Z++)for(var q=0;q<O.width;q++){var J=G[E],K=_(J);void 0!==K.id&&(U.setTile(q,Z,K.id),U.setFlippedHorizontally(q,Z,K.flippedHorizontally),U.setFlippedVertically(q,Z,K.flippedVertically),U.setFlippedDiagonally(q,Z,K.flippedDiagonally)),E+=1}}}}}catch(t){p={error:t}}finally{try{C&&!C.done&&(c=P.return)&&c.call(P)}finally{if(p)throw p.error}}return j}}(a||(a={})),function(t){t.load=function(t,e){return null}}(s||(s={})),function(t){t.load=function(t,e){return"ldtk"===e.kind?s.load(t,e.data):"tiled"===e.kind?a.load(t,e.data):(console.warn("The loaded Tile Map data does not contain a 'tiledversion' or '__header__' key. Are you sure this file has been exported from Tiled (mapeditor.org) or LDtk (ldtk.io)?"),null)}}(p||(p={}));var m=function(){function e(){this._tileMapCache=new v,this._textureCacheCaches=new v}return e.getManager=function(t){return t.tileMapCollisionMaskManager||(t.tileMapCollisionMaskManager=new e),t.tileMapCollisionMaskManager},e.identify=function(t){return t.tiledversion?(console.info("Detected the json file was created in Tiled"),{kind:"tiled",data:t}):t.__header__&&"LDtk"===t.__header__.app?(console.info("Detected the json/ldtk file was created in LDtk"),{kind:"ldtk",data:t}):(console.warn("The loaded Tile Map data does not contain a 'tiledversion' or '__header__' key. Are you sure this file has been exported from Tiled (mapeditor.org) or LDtk (ldtk.io)?"),null)},e.prototype.getOrLoadTileMap=function(t,e,i,n,l){var r=e+"|"+i;this._tileMapCache.getOrLoad(r,(function(l){t(e,i,(function(t){if(t){var e=p.load(n,t);l(e)}else l(null)}))}),l)},e.prototype.getOrLoadTextureCache=function(e,i,n,l,r,o){var a=l+"|"+r+"|"+n;this._textureCacheCaches.getOrLoad(a,(function(o){e(l,r,(function(e){if(e){var l=n?i(n):null,r=t.PixiTileMapHelper.parseAtlas(e,l,i);o(r)}else o(null)}))}),o)},e}();t.EditableTileMap=d,t.EditableTileMapLayer=y,t.TileDefinition=g,t.TileMapManager=m,t.TileTextureCache=x,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=TileMapHelper.js.map
