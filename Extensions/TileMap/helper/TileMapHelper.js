!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("pixi.js")):"function"==typeof define&&define.amd?define(["exports","pixi.js"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TileMapHelper={},e.PIXI)}(this,(function(e,t){"use strict";function i(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(i){if("default"!==i){var r=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,r.get?r:{enumerable:!0,get:function(){return e[i]}})}})),t.default=e,Object.freeze(t)}var r=i(t),n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},n(e,t)};function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}function o(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],r=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}var a=function(){function e(e,t,i,r,n){console.log("tile dimension: "+e+" "+t),this.tileWidth=e,this.tileHeight=t,this.dimX=i,this.dimY=r,this._tileSet=n,this._layers=[]}return e.prototype.getWidth=function(){return this.tileWidth*this.dimX},e.prototype.getHeight=function(){return this.tileHeight*this.dimY},e.prototype.getTileHeight=function(){return this.tileWidth},e.prototype.getTileWidth=function(){return this.tileHeight},e.prototype.getDimensionX=function(){return this.dimX},e.prototype.getDimensionY=function(){return this.dimY},e.prototype.getTileDefinition=function(e){return this._tileSet.get(e)},e.prototype.getTileDefinitions=function(){return this._tileSet.values()},e.prototype.addTileLayer=function(e){var t=new c(this,e);return this._layers.push(t),t},e.prototype.addObjectLayer=function(e){var t=new p(this,e);return this._layers.push(t),t},e.prototype.getLayers=function(){return this._layers},e.prototype.pointIsInsideTile=function(e,t,i){var r,n,l=Math.floor(e/this.tileWidth),a=Math.floor(t/this.tileHeight);try{for(var s=o(this._layers),p=s.next();!p.done;p=s.next()){var u=p.value;if(u){var f=u.get(l,a);if(!f)return!1;if(this._tileSet.get(f).getTag()===i)return!0}}}catch(e){r={error:e}}finally{try{p&&!p.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return!1},e}(),s=function(){function e(e,t){this.visible=!0,this.tileMap=e,this.id=t}return e.prototype.setVisible=function(e){this.visible=e},e.prototype.isVisible=function(){return this.visible},e}(),p=function(e){function t(t,i){var r=e.call(this,t,i)||this;return r.objects=[],r}return l(t,e),t.prototype.add=function(e){this.objects.push(e)},t}(s),u=function(){function e(e,t,i){this.tileId=i,this.x=e,this.y=t}return e.prototype.getTileId=function(){return f.getTileId(this.tileId)},e.prototype.setFlippedHorizontally=function(e){this.tileId=f.setFlippedHorizontally(this.tileId,e)},e.prototype.setFlippedVertically=function(e){this.tileId=f.setFlippedVertically(this.tileId,e)},e.prototype.setFlippedDiagonally=function(e){this.tileId=f.setFlippedDiagonally(this.tileId,e)},e.prototype.isFlippedHorizontally=function(){return f.isFlippedHorizontally(this.tileId)},e.prototype.isFlippedVertically=function(){return f.isFlippedVertically(this.tileId)},e.prototype.isFlippedDiagonally=function(){return f.isFlippedDiagonally(this.tileId)},e}(),f=function(){function e(){}return e.getTileId=function(t){return t&e.tileIdMask},e.setFlippedHorizontally=function(t,i){return t&=~e.flippedHorizontallyFlag,i&&(t|=e.flippedHorizontallyFlag),t},e.setFlippedVertically=function(t,i){return t&=~e.flippedVerticallyFlag,i&&(t|=e.flippedVerticallyFlag),t},e.setFlippedDiagonally=function(t,i){return t&=~e.flippedDiagonallyFlag,i&&(t|=e.flippedDiagonallyFlag),t},e.isFlippedHorizontally=function(t){return 0!=(t&e.flippedHorizontallyFlag)},e.isFlippedVertically=function(t){return 0!=(t&e.flippedVerticallyFlag)},e.isFlippedDiagonally=function(t){return 0!=(t&e.flippedDiagonallyFlag)},e.flippedHorizontallyFlag=2147483648,e.flippedVerticallyFlag=1073741824,e.flippedDiagonallyFlag=536870912,e.tileIdMask=~(e.flippedHorizontallyFlag|e.flippedVerticallyFlag|e.flippedDiagonallyFlag),e}(),c=function(e){function t(t,i){var r=e.call(this,t,i)||this;r._tiles=[],r._tiles.length=r.tileMap.getDimensionY();for(var n=0;n<r._tiles.length;n++)r._tiles[n]=new Int32Array(r.tileMap.getDimensionX());return r}return l(t,e),t.prototype.setTile=function(e,t,i){if(!this.tileMap.getTileDefinition(i))throw new Error("Invalid tile definition index: ".concat(i));this._tiles[t][e]=i+1},t.prototype.removeTile=function(e,t){this._tiles[t][e]=0},t.prototype.setFlippedHorizontally=function(e,t,i){var r=this._tiles[t][e];0!==r&&(this._tiles[t][e]=f.setFlippedHorizontally(r,i))},t.prototype.setFlippedVertically=function(e,t,i){var r=this._tiles[t][e];0!==r&&(this._tiles[t][e]=f.setFlippedVertically(r,i))},t.prototype.setFlippedDiagonally=function(e,t,i){var r=this._tiles[t][e];0!==r&&(this._tiles[t][e]=f.setFlippedDiagonally(r,i))},t.prototype.isFlippedHorizontally=function(e,t){return f.isFlippedHorizontally(this._tiles[t][e])},t.prototype.isFlippedVertically=function(e,t){return f.isFlippedVertically(this._tiles[t][e])},t.prototype.isFlippedDiagonally=function(e,t){return f.isFlippedDiagonally(this._tiles[t][e])},t.prototype.get=function(e,t){var i=this._tiles[t];if(i&&0!==i[e])return f.getTileId(i[e]-1)},t.prototype.getDimensionX=function(){return 0===this._tiles.length?0:this._tiles[0].length},t.prototype.getDimensionY=function(){return this._tiles.length},t.prototype.getWidth=function(){return this.tileMap.getWidth()},t.prototype.getHeight=function(){return this.tileMap.getHeight()},t}(s),d=function(){function e(e,t,i){this.hitBoxes=e,this.tag=t,this.animationLength=i}return e.prototype.getTag=function(){return this.tag},e.prototype.getHiBoxes=function(){return this.hitBoxes},e.prototype.getAnimationLength=function(){return this.animationLength},e}(),h=function(){function e(){this._cachedValues=new Map,this._callbacks=new Map}return e.prototype.getOrLoad=function(e,t,i){var r=this,n=this._cachedValues.get(e);if(n)i(n);else{var l=this._callbacks.get(e);l?l.push(i):(this._callbacks.set(e,[i]),t((function(t){var i,n;t&&r._cachedValues.set(e,t);var l=r._callbacks.get(e);r._callbacks.delete(e);try{for(var a=o(l),s=a.next();!s.done;s=a.next()){(0,s.value)(t)}}catch(e){i={error:e}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(i)throw i.error}}})))}},e}(),y=function(e,t){var i=t.data,r=t.compression;if(!i)return i;var n=4,l=[],o=atob(i).split("").map((function(e){return e.charCodeAt(0)}));try{var a=function(e,t){return e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24)>>>0};if("zlib"===r)for(var s=new Uint8Array(o),p=e.inflate(s);n<=p.length;)l.push(a(p,n-4)),n+=4;else{if("zstd"===r)return console.error("Zstandard compression is not supported for layers in a Tilemap. Use instead zlib compression or no compression."),null;for(;n<=o.length;)l.push(a(o,n-4)),n+=4}return l}catch(e){return console.error("Failed to decompress and unzip base64 layer.data string",e),null}},g=function(e){var t=2147483648,i=1073741824,r=536870912;return{id:536870911&e,flippedHorizontally:!!(e&t),flippedVertically:!!(e&i),flippedDiagonally:!!(e&r)}},v=function(){function e(){}return e.load=function(e,t){var i,r,n,l,s,p,f,c;if(!t.tiledversion)return console.warn("The loaded Tiled map does not contain a 'tiledversion' key. Are you sure this file has been exported from Tiled (mapeditor.org)?"),null;var h=new Map;try{for(var v=o(t.tilesets[0].tiles),F=v.next();!F.done;F=v.next()){var x=F.value,T=[];if(x.objectgroup)try{for(var b=(n=void 0,o(x.objectgroup.objects)),_=b.next();!_.done;_=b.next()){var m=_.value,w=null;w=m.polygon?m.polygon.map((function(e){return[e.x,e.y]})):[[m.x,m.y],[m.x,m.y+m.height],[m.x+m.width,m.y+m.height],[m.x+m.width,m.y]],T.push(w)}}catch(e){n={error:e}}finally{try{_&&!_.done&&(l=b.return)&&l.call(b)}finally{if(n)throw n.error}}h.set(x.id,new d(T,x.type?x.type:"",x.animation?x.animation.length:0))}}catch(e){i={error:e}}finally{try{F&&!F.done&&(r=v.return)&&r.call(v)}finally{if(i)throw i.error}}for(var M=0;M<t.tilesets[0].tilecount;M++)h.has(M)||h.set(M,new d([],"",0));var D=new a(t.tilewidth,t.tileheight,t.width,t.height,h);try{for(var H=o(t.layers),V=H.next();!V.done;V=H.next()){var z=V.value;if("objectgroup"===z.type){var I=D.addObjectLayer(z.id);I.setVisible(z.visible);try{for(var j=(f=void 0,o(z.objects)),O=j.next();!O.done;O=j.next()){var L=O.value;if(L.visible){var k=g(L.gid);m=new u(L.x,L.y,k.id);I.add(m),m.setFlippedHorizontally(k.flippedHorizontally),m.setFlippedVertically(k.flippedVertically),m.setFlippedDiagonally(k.flippedDiagonally)}}}catch(e){f={error:e}}finally{try{O&&!O.done&&(c=j.return)&&c.call(j)}finally{if(f)throw f.error}}}else if("tilelayer"===z.type){var C=0,A=null;if("base64"===z.encoding?(A=y(e,z))||console.warn("Failed to uncompress layer.data"):A=z.data,A){var P=D.addTileLayer(z.id);P.setVisible(z.visible);for(var X=0;X<z.height;X++)for(var W=0;W<z.width;W++){var S=A[C],Y=g(S);Y.id>0&&(P.setTile(W,X,Y.id-1),P.setFlippedHorizontally(W,X,Y.flippedHorizontally),P.setFlippedVertically(W,X,Y.flippedVertically),P.setFlippedDiagonally(W,X,Y.flippedDiagonally)),C+=1}}}}}catch(e){s={error:e}}finally{try{V&&!V.done&&(p=H.return)&&p.call(H)}finally{if(s)throw s.error}}return D},e}(),F=function(){function e(){this._textures=new Map}return e.prototype.setTexture=function(e,t,i,r,n){var l=this._getGlobalId(e,t,i,r);this._textures.set(l,n)},e.prototype.findTileTexture=function(e,t,i,n){var l=this._getGlobalId(e,t,i,n);if(0!==l){if(this._textures.has(l))return this._textures.get(l);var o=this._textures.get(e);if(o){var a=o.frame.clone(),s=o.orig.clone();if(n){var p=s.width;s.width=s.height,s.height=p}var u=s.clone(),f=0;n?(f=10,!t&&i?f=2:t&&!i?f=6:t&&i&&(f=14)):(f=0,!t&&i?f=8:t&&!i?f=12:t&&i&&(f=4));var c=new r.Texture(o.baseTexture,a,s,u,f);return this._textures.set(l,c),c}}},e.prototype._getGlobalId=function(t,i,r,n){var l=t;return i&&(l|=e.flippedHorizontallyFlag),r&&(l|=e.flippedVerticallyFlag),n&&(l|=e.flippedDiagonallyFlag),l},e.flippedHorizontallyFlag=2147483648,e.flippedVerticallyFlag=1073741824,e.flippedDiagonallyFlag=536870912,e}(),x=function(){function e(){}return e.parseAtlas=function(e,t,i){if(!e.tiledversion)return console.warn("The loaded Tiled map does not contain a 'tiledversion' key. Are you sure this file has been exported from Tiled (mapeditor.org)?"),null;if(!e.tilesets.length||"source"in e.tilesets[0])return console.warn("The loaded Tiled map seems not to contain any tileset data (nothing in 'tilesets' key)."),null;var n=e.tilesets[0],l=n.tilewidth,o=n.tileheight,a=n.tilecount;n.tiles;var s=n.image,p=n.columns,u=n.spacing,f=n.margin;t||(t=i(s));var c=a/p,d=l*p+u*(p-1)+2*f,h=o*c+u*(c-1)+2*f;if(1!==t.width&&d!==t.width||1!==t.height&&h!==t.height){var y=d+"x"+h,g=t.width+"x"+t.height;return console.warn("It seems the atlas file was resized, which is not supported. It should be "+y+"px, but it's "+g+" px."),null}for(var v=new F,x=0;x<a;x++){var T=f+Math.floor(x%p)*(l+u),b=f+Math.floor(x/p)*(o+u);try{var _=new r.Rectangle(T,b,l,o),m=new r.Texture(t,_);v.setTexture(x,!1,!1,!1,m)}catch(e){console.error("An error occurred while creating a PIXI.Texture to be used in a TileMap:",e)}}return v},e.updatePixiTileMap=function(e,t,i,r,n){var l,a,s,u;if(e){e.clear();try{for(var f=o(t.getLayers()),d=f.next();!d.done;d=f.next()){var h=d.value;if("index"===r&&n!==h.id||"visible"===r&&!h.isVisible())return;if(h instanceof p){var y=h;try{for(var g=(s=void 0,o(y.objects)),v=g.next();!v.done;v=g.next()){var F=v.value,x=i.findTileTexture(F.getTileId(),F.isFlippedHorizontally(),F.isFlippedVertically(),F.isFlippedDiagonally());x&&e.addFrame(x,F.x,F.y-y.tileMap.getTileHeight())}}catch(e){s={error:e}}finally{try{v&&!v.done&&(u=g.return)&&u.call(g)}finally{if(s)throw s.error}}}else if(h instanceof c)for(var T=h,b=0;b<T.tileMap.getDimensionY();b++)for(var _=0;_<T.tileMap.getDimensionX();_++){var m=T.tileMap.getTileWidth(),w=m*_,M=T.tileMap.getTileHeight()*b,D=T.get(_,b),H=i.findTileTexture(D,T.isFlippedHorizontally(_,b),T.isFlippedVertically(_,b),T.isFlippedDiagonally(_,b));if(H){var V=e.addFrame(H,w,M),z=T.tileMap.getTileDefinition(D);z&&z.getAnimationLength()>0&&V.tileAnimX(m,z.getAnimationLength())}}}}catch(e){l={error:e}}finally{try{d&&!d.done&&(a=f.return)&&a.call(f)}finally{if(l)throw l.error}}}},e.updatePixiCollisionMask=function(e,t,i,r,n,l,a,s,p,u){var f,d,h,y;if(e){e.clear();try{for(var g=o(t.getLayers()),v=g.next();!v.done;v=g.next()){var F=v.value;if("index"===i&&r!==F.id)return;var x=t.getTileWidth(),T=t.getTileHeight();if(F instanceof c)for(var b=F,_=0;_<b.tileMap.getDimensionY();_++)for(var m=0;m<b.tileMap.getDimensionX();m++){var w=x*m,M=T*_,D=b.get(m,_),H=b.isFlippedHorizontally(m,_),V=b.isFlippedVertically(m,_),z=b.isFlippedDiagonally(m,_),I=b.tileMap.getTileDefinition(D);if(I&&I.getTag()===n){e.lineStyle(l,a,s);try{for(var j=(h=void 0,o(I.getHiBoxes())),O=j.next();!O.done;O=j.next()){var L=O.value;if(0!==L.length){e.beginFill(p,u);for(var k=0;k<L.length;k++){var C=L[k][0],A=L[k][1];if(H&&(C=x-C),V&&(A=T-A),z){var P=C;C=A,A=P}0===k?e.moveTo(w+C,M+A):e.lineTo(w+C,M+A)}e.closePath(),e.endFill()}}}catch(e){h={error:e}}finally{try{O&&!O.done&&(y=j.return)&&y.call(j)}finally{if(h)throw h.error}}}}}}catch(e){f={error:e}}finally{try{v&&!v.done&&(d=g.return)&&d.call(g)}finally{if(f)throw f.error}}}},e}(),T=function(){function e(){this._tileMapCache=new h,this._textureCacheCaches=new h}return e.getManager=function(t){return t.tileMapCollisionMaskManager||(t.tileMapCollisionMaskManager=new e),t.tileMapCollisionMaskManager},e.prototype.getOrLoadTileMap=function(e,t,i,r,n){var l=t+"|"+i;this._tileMapCache.getOrLoad(l,(function(n){e(t,i,(function(e){if(e){var t=v.load(r,e);n(t)}else n(null)}))}),n)},e.prototype.getOrLoadTextureCache=function(e,t,i,r,n,l){var o=r+"|"+n+"|"+i;this._textureCacheCaches.getOrLoad(o,(function(l){e(r,n,(function(e){if(e){var r=i?t(i):null,n=x.parseAtlas(e,r,t);l(n)}else l(null)}))}),l)},e}();e.EditableTileMap=a,e.EditableTileMapLayer=c,e.PixiTileMapHelper=x,e.TileDefinition=d,e.TileMapManager=T,e.TileTextureCache=F,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=TileMapHelper.js.map
